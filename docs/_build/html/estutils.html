
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Estimation Utilities (mlsynth.utils.estutils) &#8212; mlsynth 0.1.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=1a9ffd16"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/static/custom_mathjax.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'estutils';</script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Inference Utilities (mlsynth.utils.inferutils)" href="inferutils.html" />
    <link rel="prev" title="Data Utilities (mlsynth.utils.datautils)" href="datautils.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">mlsynth 0.1.1 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="about.html">About mlsynth</a></li>

<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Estimators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="clustersc.html">Cluster Synthetic Controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="fdid.html">Forward Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="fma.html">Factor Model Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="fscm.html">Forward SCM</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="gsc.html">Generalized Synthetic Control (GSC)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/mlsynth.estimators.gsc.GSC.html">mlsynth.estimators.gsc.GSC</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="nsc.html">Nonlinear Synthetic Control (NSC)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/mlsynth.estimators.nsc.NSC.html">mlsynth.estimators.nsc.NSC</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="pda.html">Panel Data Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="proximal.html">Proximal Synthetic Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="scmo.html">Synthetic Control With Multiple Outcomes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="sdid.html">Synthetic Difference-in-Differences (SDID)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/mlsynth.estimators.sdid.SDID.html">mlsynth.estimators.sdid.SDID</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="si.html">Synthetic Interventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="src.html">Synthetic Regression Control Method</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="stablesc.html">Stable Synthetic Control (StableSC)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/mlsynth.estimators.stablesc.StableSC.html">mlsynth.estimators.stablesc.StableSC</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="tssc.html">Two-Step Synthetic Control</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Utilities</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="datautils.html">Data Utilities (<cite>mlsynth.utils.datautils</cite>)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Estimation Utilities (<cite>mlsynth.utils.estutils</cite>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="inferutils.html">Inference Utilities (<cite>mlsynth.utils.inferutils</cite>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="resultutils.html">Result Utilities (<cite>mlsynth.utils.resultutils</cite>)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/estutils.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Estimation Utilities (mlsynth.utils.estutils)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-reference">Class Reference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.Opt"><code class="docutils literal notranslate"><span class="pre">Opt</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.Opt.SCopt"><code class="docutils literal notranslate"><span class="pre">Opt.SCopt()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#function-reference">Function Reference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi2"><code class="docutils literal notranslate"><span class="pre">pi2()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.compute_hac_variance"><code class="docutils literal notranslate"><span class="pre">compute_hac_variance()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.compute_t_stat_and_ci"><code class="docutils literal notranslate"><span class="pre">compute_t_stat_and_ci()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.l2_relax"><code class="docutils literal notranslate"><span class="pre">l2_relax()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.cross_validate_tau"><code class="docutils literal notranslate"><span class="pre">cross_validate_tau()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.ci_bootstrap"><code class="docutils literal notranslate"><span class="pre">ci_bootstrap()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.TSEST"><code class="docutils literal notranslate"><span class="pre">TSEST()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pda"><code class="docutils literal notranslate"><span class="pre">pda()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.bartlett"><code class="docutils literal notranslate"><span class="pre">bartlett()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.hac"><code class="docutils literal notranslate"><span class="pre">hac()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi"><code class="docutils literal notranslate"><span class="pre">pi()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi_surrogate"><code class="docutils literal notranslate"><span class="pre">pi_surrogate()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi_surrogate_post"><code class="docutils literal notranslate"><span class="pre">pi_surrogate_post()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.get_theta"><code class="docutils literal notranslate"><span class="pre">get_theta()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.get_sigmasq"><code class="docutils literal notranslate"><span class="pre">get_sigmasq()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.SRCest"><code class="docutils literal notranslate"><span class="pre">SRCest()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.RPCASYNTH"><code class="docutils literal notranslate"><span class="pre">RPCASYNTH()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.SMOweights"><code class="docutils literal notranslate"><span class="pre">SMOweights()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.NSC_opt"><code class="docutils literal notranslate"><span class="pre">NSC_opt()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.NSCcv"><code class="docutils literal notranslate"><span class="pre">NSCcv()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pcr"><code class="docutils literal notranslate"><span class="pre">pcr()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-helper-functions">Internal Helper Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._estimate_single_sc_model_for_tsest"><code class="docutils literal notranslate"><span class="pre">_estimate_single_sc_model_for_tsest()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_fs"><code class="docutils literal notranslate"><span class="pre">_solve_pda_fs()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_lasso"><code class="docutils literal notranslate"><span class="pre">_solve_pda_lasso()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_l2"><code class="docutils literal notranslate"><span class="pre">_solve_pda_l2()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.__SRC_opt"><code class="docutils literal notranslate"><span class="pre">__SRC_opt()</span></code></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="estimation-utilities-mlsynth-utils-estutils">
<h1>Estimation Utilities (<cite>mlsynth.utils.estutils</cite>)<a class="headerlink" href="#estimation-utilities-mlsynth-utils-estutils" title="Link to this heading">#</a></h1>
<p>This module provides a collection of utility functions supporting various estimation procedures within the <cite>mlsynth</cite> library. These include optimization routines for Synthetic Control Methods (SCM), cross-validation helpers, inference utilities, and specific algorithms for methods like Panel Data Approach (PDA) and Proximal Inference.</p>
<section id="class-reference">
<h2>Class Reference<a class="headerlink" href="#class-reference" title="Link to this heading">#</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.Opt">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">Opt</span></span><a class="headerlink" href="#mlsynth.utils.estutils.Opt" title="Link to this definition">#</a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a></p>
<dl class="py method">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.Opt.SCopt">
<em class="property"><span class="k"><span class="pre">static</span></span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">SCopt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">num_control_units</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scm_model_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'MSCb'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">base_model_results_for_averaging</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Problem</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.Opt.SCopt" title="Link to this definition">#</a></dt>
<dd><p>Perform optimization for various Synthetic Control Method (SCM) variants.</p>
<p>This static method sets up and solves the SCM optimization problem
using CVXPY for different model specifications like standard SCM
(with or without intercept, with or without simplex constraint),
OLS, or Model Averaging.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_control_units</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of control units (donors) or columns in the input matrix
<cite>donor_outcomes_pre_treatment</cite>. This should be the count before
any intercept is added internally.</p></li>
<li><p><strong>target_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Target vector for the pre-treatment periods, shape
(num_pre_treatment_periods,). This is typically the outcome of the
treated unit in the pre-treatment phase.</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods. This defines the length of
<cite>target_outcomes_pre_treatment</cite> and the number of rows of
<cite>donor_outcomes_pre_treatment</cite> used for fitting.</p></li>
<li><p><strong>donor_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Donor matrix for the pre-treatment periods, shape
(num_pre_treatment_periods, num_control_units). Each column
represents a donor unit’s outcomes or features.</p></li>
<li><p><strong>scm_model_type</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) – <p>The SCM optimization model to use. Options are:</p>
<ul>
<li><p>’MSCa’: SCM with an intercept, weights for donors sum to 1, all non-negative.</p></li>
<li><p>’MSCb’: SCM without intercept, weights non-negative. (Default)</p></li>
<li><p>’MSCc’: SCM with an intercept, donor weights non-negative.</p></li>
<li><p>’SIMPLEX’: SCM without intercept, weights non-negative and sum to 1.</p></li>
<li><p>’OLS’: Ordinary Least Squares, weights are unconstrained.</p></li>
<li><p>’MA’: Model Averaging. Requires <cite>base_model_results_for_averaging</cite>.</p></li>
</ul>
<p>Default is _SCM_MODEL_MSCB.</p>
</p></li>
<li><p><strong>base_model_results_for_averaging</strong> (<em>Optional</em><em>[</em><em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em><em>]</em><em>]</em><em>, </em><em>optional</em>) – <p>Required if <cite>scm_model_type</cite> is _SCM_MODEL_MA. A dictionary where
keys are model names (strings) and values are dictionaries. Each
inner dictionary must contain:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">'weights'</span></code><span class="classifier">np.ndarray</span></dt><dd><p>The SCM weights obtained from that model.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">'cf'</span></code><span class="classifier">np.ndarray</span></dt><dd><p>The counterfactual predictions for the pre-treatment
period (length <cite>num_pre_treatment_periods</cite>) from that model.</p>
</dd>
</dl>
<p>Default is None.</p>
</p></li>
<li><p><strong>donor_names</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>]</em><em>]</em><em>, </em><em>optional</em>) – List of donor names. Currently used by some internal model types if they
handle intercepts or specific donor selections. Default is None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>The result of the SCM optimization.
If <cite>scm_model_type</cite> is _SCM_MODEL_MA, returns a dictionary with keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">&quot;Lambdas&quot;</span></code><span class="classifier">Dict[str, float]</span></dt><dd><p>Model names mapped to their lambda (averaging) weights.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&quot;w_MA&quot;</span></code><span class="classifier">np.ndarray</span></dt><dd><p>The final model-averaged SCM weights for donors.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">&quot;Counterfactual_pre&quot;</span></code><span class="classifier">np.ndarray</span></dt><dd><p>The model-averaged counterfactual prediction for the
pre-treatment period, shape (num_pre_treatment_periods,).</p>
</dd>
</dl>
<p>Otherwise (for _SCM_MODEL_MSCA, _SCM_MODEL_MSCB, _SCM_MODEL_MSCC,
_SCM_MODEL_SIMPLEX, _SCM_MODEL_OLS), returns a <cite>cvxpy.Problem</cite>
object after it has been solved. The estimated SCM weights can be
accessed via:
<cite>problem.solution.primal_vars[next(iter(problem.solution.primal_vars))]</cite>.
If an intercept was added (e.g., _SCM_MODEL_MSCA, _SCM_MODEL_MSCC),
it will be the first element of the weight vector.</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[cp.Problem, Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>MlsynthDataError</strong> – If <cite>donor_outcomes_pre_treatment</cite> and
    <cite>target_outcomes_pre_treatment</cite> dimensions (after slicing to
    <cite>num_pre_treatment_periods</cite>) are inconsistent for non-MA models.</p></li>
<li><p><strong>MlsynthConfigError</strong> – If <cite>scm_model_type</cite> is _SCM_MODEL_MA and
    <cite>base_model_results_for_averaging</cite> is not provided or is
    malformed, or if an unsupported <cite>scm_model_type</cite> is provided.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>For models _SCM_MODEL_MSCA and _SCM_MODEL_MSCC, an intercept term is
automatically added to the <cite>donor_outcomes_pre_treatment</cite> matrix
internally. The <cite>num_control_units</cite> parameter is incremented
accordingly, and the returned weight vector will include the intercept
as its first element.</p></li>
<li><p>The method solves <cite>min ||y - Xw||_2^2</cite> subject to constraints
defined by the <cite>scm_model_type</cite> type.</p></li>
<li><p>CVXPY’s CLARABEL solver is used.</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">T_pre_ex</span><span class="p">,</span> <span class="n">N_donors_ex</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_pre_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_pre_ex</span><span class="p">,</span> <span class="n">N_donors_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Solve for SIMPLEX model (weights non-negative, sum to 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prob_simplex</span> <span class="o">=</span> <span class="n">Opt</span><span class="o">.</span><span class="n">SCopt</span><span class="p">(</span><span class="n">N_donors_ex</span><span class="p">,</span> <span class="n">y_ex</span><span class="p">,</span> <span class="n">T_pre_ex</span><span class="p">,</span> <span class="n">X_ex</span><span class="p">,</span> <span class="n">scm_model_type</span><span class="o">=</span><span class="n">_SCM_MODEL_SIMPLEX</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">prob_simplex</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;optimal&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">weights_simplex</span> <span class="o">=</span> <span class="n">prob_simplex</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">primal_vars</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">prob_simplex</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">primal_vars</span><span class="p">))]</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simplex weights sum: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_simplex</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Are weights non-negative: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">weights_simplex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mf">1e-5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Allow for small numerical errors</span>
<span class="go">Simplex weights sum: 1.00</span>
<span class="go">Are weights non-negative: True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Solve for MSCb model (weights non-negative)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prob_mscb</span> <span class="o">=</span> <span class="n">Opt</span><span class="o">.</span><span class="n">SCopt</span><span class="p">(</span><span class="n">N_donors_ex</span><span class="p">,</span> <span class="n">y_ex</span><span class="p">,</span> <span class="n">T_pre_ex</span><span class="p">,</span> <span class="n">X_ex</span><span class="p">,</span> <span class="n">scm_model_type</span><span class="o">=</span><span class="n">_SCM_MODEL_MSCB</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">prob_mscb</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;optimal&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">weights_mscb</span> <span class="o">=</span> <span class="n">prob_mscb</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">primal_vars</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">prob_mscb</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">primal_vars</span><span class="p">))]</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Are MSCb weights non-negative: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">weights_mscb</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mf">1e-5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Are MSCb weights non-negative: True</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="function-reference">
<h2>Function Reference<a class="headerlink" href="#function-reference" title="Link to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pi2">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pi2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">proxy_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_periods_for_se</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">total_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">hac_lag_length</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">covariates_for_W</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">covariates_for_Z0</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pi2" title="Link to this definition">#</a></dt>
<dd><p>Proximal inference for treatment effect estimation using GMM.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector (total_periods,).</p></li>
<li><p><strong>design_matrix</strong> (<em>np.ndarray</em>) – Design matrix (total_periods, dim_design_matrix).</p></li>
<li><p><strong>proxy_matrix</strong> (<em>np.ndarray</em>) – Proxy matrix (total_periods, dim_proxy_matrix).</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods.</p></li>
<li><p><strong>num_post_periods_for_se</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods to consider for averaging the treatment effect
when calculating its standard error.</p></li>
<li><p><strong>total_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Total number of time periods in <cite>outcome_vector</cite>, <cite>design_matrix</cite>, <cite>proxy_matrix</cite>.</p></li>
<li><p><strong>hac_lag_length</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – HAC lag length for variance estimation.</p></li>
<li><p><strong>covariates_for_W</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Covariates to augment <cite>design_matrix</cite>. If provided, <cite>covariates_for_Z0</cite> must also be provided.
Shape should be (total_periods, dim_covariates_W). Default is None.</p></li>
<li><p><strong>covariates_for_Z0</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Covariates to augment <cite>proxy_matrix</cite>. If provided, <cite>covariates_for_W</cite> must also be provided.
Shape should be (total_periods, dim_covariates_Z0). Default is None.
Note: <cite>dim_covariates_W</cite> and <cite>dim_covariates_Z0</cite> must be such that <cite>design_matrix</cite> and <cite>proxy_matrix</cite>
can be augmented to have the same number of columns.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>predicted_counterfactual_original_W<span class="classifier">np.ndarray</span></dt><dd><p>Predicted counterfactual outcomes using the original design matrix and
its estimated coefficients. Shape (total_periods,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>alpha_coefficients_original_W<span class="classifier">np.ndarray</span></dt><dd><p>Estimated coefficients for the original design matrix. Shape (dim_design_matrix,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>standard_error_tau_placeholder<span class="classifier">float</span></dt><dd><p>Placeholder for the standard error of the treatment effect.
Currently returns <cite>np.nan</cite>.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, np.ndarray, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>MlsynthConfigError</strong> – If augmented design_matrix and proxy_matrix do not have the same number of columns.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.compute_hac_variance">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">compute_hac_variance</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">treatment_effects_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></span><a class="headerlink" href="#mlsynth.utils.estutils.compute_hac_variance" title="Link to this definition">#</a></dt>
<dd><p>Compute the HAC long-run variance estimator with truncation lag.</p>
<p>Uses Bartlett kernel.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>treatment_effects_vector</strong> (<em>np.ndarray</em>) – Array of estimated treatment effects, typically for each post-treatment period.
Shape (num_effects_observations,), where num_effects_observations is the number of post-treatment observations.</p></li>
<li><p><strong>truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – The truncation lag for the Bartlett kernel. This determines how many
autocovariances are included in the sum. A common rule of thumb for this lag
is <code class="docutils literal notranslate"><span class="pre">floor(4</span> <span class="pre">*</span> <span class="pre">(num_effects_observations/100)**(2/9))</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The Heteroskedasticity and Autocorrelation Consistent (HAC) variance estimate.
Returns <cite>np.nan</cite> if <cite>num_effects_observations</cite> is 0.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.compute_t_stat_and_ci">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">compute_t_stat_and_ci</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">average_treatment_effect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">post_treatment_effects_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">confidence_level</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.95</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.compute_t_stat_and_ci" title="Link to this definition">#</a></dt>
<dd><p>Compute the t-statistic and confidence interval for ATT.</p>
<p>Uses HAC variance for standard error calculation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>average_treatment_effect</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Average treatment effect on the treated (ATT).</p></li>
<li><p><strong>post_treatment_effects_vector</strong> (<em>np.ndarray</em>) – Array of estimated treatment effects for post-treatment periods,
shape (num_post_treatment_obs,).</p></li>
<li><p><strong>truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – The truncation lag for HAC variance.</p></li>
<li><p><strong>confidence_level</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a><em>, </em><em>optional</em>) – Desired confidence level, by default 0.95.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>t_statistic_value<span class="classifier">float</span></dt><dd><p>The computed t-statistic for the ATT.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>confidence_interval<span class="classifier">Tuple[float, float]</span></dt><dd><p>A tuple containing the lower and upper bounds of the confidence interval
for the ATT.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]]</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">average_treatment_effect_example</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">post_effects_vector_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">truncation_lag_example</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t_statistic_value_example</span><span class="p">,</span> <span class="n">confidence_interval_example</span> <span class="o">=</span> <span class="n">compute_t_stat_and_ci</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">average_treatment_effect_example</span><span class="p">,</span> <span class="n">post_effects_vector_example</span><span class="p">,</span> <span class="n">truncation_lag_example</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-statistic: </span><span class="si">{</span><span class="n">t_statistic_value_example</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">t-statistic: 12.55</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CI: (</span><span class="si">{</span><span class="n">confidence_interval_example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">confidence_interval_example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="go">CI: (0.42, 0.58)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.l2_relax">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">l2_relax</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_estimation_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">treated_unit_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sup_norm_constraint_tau</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.l2_relax" title="Link to this definition">#</a></dt>
<dd><p>L2-relaxation estimator for time-series panel data.</p>
<p>Intercept is estimated separately after learning coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_pre_treatment_estimation_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of initial time periods (pre-treatment) to use for estimation.</p></li>
<li><p><strong>treated_unit_outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit, shape (T_total,).</p></li>
<li><p><strong>donor_outcomes_matrix</strong> (<em>np.ndarray</em>) – Design matrix (control units), shape (T_total, N_controls).</p></li>
<li><p><strong>sup_norm_constraint_tau</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Tuning parameter for the sup-norm constraint.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>coefficients<span class="classifier">np.ndarray</span></dt><dd><p>Estimated coefficients for control units. Shape (N_controls,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>intercept<span class="classifier">float</span></dt><dd><p>Estimated intercept term.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>counterfactuals<span class="classifier">np.ndarray</span></dt><dd><p>Predicted counterfactual outcomes for the treated unit for all <cite>T_total</cite>
periods. Shape (T_total,).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, np.ndarray]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>MlsynthEstimationError</strong> – If CVXPY optimization fails to find an optimal solution.</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">T_total_example</span><span class="p">,</span> <span class="n">N_donors_example</span><span class="p">,</span> <span class="n">T_pre_estimation_example</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_vector_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_total_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_outcomes_matrix_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_total_example</span><span class="p">,</span> <span class="n">N_donors_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tau_value_example</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">estimated_coefficients_example</span><span class="p">,</span> <span class="n">estimated_intercept_example</span><span class="p">,</span> <span class="n">predicted_counterfactuals_example</span> <span class="o">=</span> <span class="n">l2_relax</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">T_pre_estimation_example</span><span class="p">,</span> <span class="n">treated_outcome_vector_example</span><span class="p">,</span> <span class="n">donor_outcomes_matrix_example</span><span class="p">,</span> <span class="n">tau_value_example</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">estimated_coefficients_example</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(3,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">predicted_counterfactuals_example</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(20,)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.cross_validate_tau">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">cross_validate_tau</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pre_treatment_treated_outcome</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre_treatment_donor_outcomes</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tau_upper_bound_for_grid</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_tau_grid_points</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">1000</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.cross_validate_tau" title="Link to this definition">#</a></dt>
<dd><p>Cross-validation for L2-relaxation to select optimal tau.</p>
<p>Splits pre-treatment data into two halves for training and validation.
No intercept is included in this CV process.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>pre_treatment_treated_outcome</strong> (<em>np.ndarray</em>) – Pre-treatment outcome vector for the treated unit, shape (T_pre,).</p></li>
<li><p><strong>pre_treatment_donor_outcomes</strong> (<em>np.ndarray</em>) – Pre-treatment design matrix (control units), shape (T_pre, N_controls).</p></li>
<li><p><strong>tau_upper_bound_for_grid</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Upper bound for tau values to test.</p></li>
<li><p><strong>num_tau_grid_points</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a><em>, </em><em>optional</em>) – Number of tau values to evaluate, by default 1000.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>optimal_tau<span class="classifier">float</span></dt><dd><p>The tau value from <cite>tau_values_grid</cite> that results in the minimum
mean squared error on the validation set.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>min_mse<span class="classifier">float</span></dt><dd><p>The minimum mean squared error achieved on the validation set
corresponding to <cite>optimal_tau</cite>.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pre_treated_outcome_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pre_donor_outcomes_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tau_upper_bound_example</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">optimal_tau_example</span><span class="p">,</span> <span class="n">min_mse_example</span> <span class="o">=</span> <span class="n">cross_validate_tau</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">pre_treated_outcome_example</span><span class="p">,</span> <span class="n">pre_donor_outcomes_example</span><span class="p">,</span> <span class="n">tau_upper_bound_example</span><span class="p">,</span> <span class="n">num_tau_grid_points</span><span class="o">=</span><span class="mi">10</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal tau: </span><span class="si">{</span><span class="n">optimal_tau_example</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Min MSE: </span><span class="si">{</span><span class="n">min_mse_example</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Optimal tau: 0.0464, Min MSE: 0.0727</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.ci_bootstrap">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">ci_bootstrap</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">original_scm_weights</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_control_units_or_features</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_feature_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">treated_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_bootstrap_samples</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">original_average_treatment_effect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">scm_method_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">original_counterfactual_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">confidence_level</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0.95</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.ci_bootstrap" title="Link to this definition">#</a></dt>
<dd><p>Perform subsampling bootstrap for TSSC methods.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>original_scm_weights</strong> (<em>np.ndarray</em>) – Original SCM weights. Shape can be (num_control_units_or_features,) or (N_features,) if no intercept,
or (num_control_units_or_features+1,) or (N_features+1,) if an intercept is included by the method
(e.g., for “MSCa”, “MSCc”). The internal logic adjusts features for dot
product based on <cite>scm_method_name</cite>.</p></li>
<li><p><strong>num_control_units_or_features</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of original control units (donors) or features before any
potential intercept addition by <cite>Opt.SCopt</cite>.</p></li>
<li><p><strong>donor_feature_matrix</strong> (<em>np.ndarray</em>) – Feature matrix for donors, shape (total_time_periods, N_features).</p></li>
<li><p><strong>treated_outcome_vector</strong> (<em>np.ndarray</em>) – Target vector (total_time_periods,).</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods.</p></li>
<li><p><strong>num_bootstrap_samples</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of bootstrap samples.</p></li>
<li><p><strong>original_average_treatment_effect</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Original Average Treatment Effect on Treated.</p></li>
<li><p><strong>scm_method_name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a>) – Name of the SCM method used (e.g., “MSCb”, “MSCa”).</p></li>
<li><p><strong>original_counterfactual_outcome_vector</strong> (<em>np.ndarray</em>) – Original counterfactual outcome vector (total_time_periods,).</p></li>
<li><p><strong>confidence_level</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a><em>, </em><em>optional</em>) – The desired confidence level for the interval, by default 0.95.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list containing two floats: <cite>[lower_bound, upper_bound]</cite> for the
confidence interval of the ATT, at the specified <cite>confidence_level</cite>.
Returns <cite>[np.nan, np.nan]</cite> if <cite>pre_treatment_subsample_size</cite> is non-positive.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>List[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>This function implements a subsampling bootstrap procedure tailored for
Two-Step Synthetic Control (TSSC) methods. It involves simulating
post-treatment errors and re-estimating SCM weights on subsamples
of the pre-treatment data to construct a distribution for the ATT.
The <cite>Opt.SCopt</cite> method is called internally for re-estimation.
Reproducibility is ensured by <cite>np.random.seed(_BOOTSTRAP_RANDOM_SEED)</cite>.</p>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># This is a complex function to exemplify simply due to Opt.SCopt dependency.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># A conceptual example:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_donors_example</span><span class="p">,</span> <span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_features_example</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">original_weights_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span> <span class="c1"># Example weights</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_features_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_features_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">original_counterfactual_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">original_att_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">treated_outcome_example</span><span class="p">[</span><span class="n">num_pre_periods_example</span><span class="p">:]</span> <span class="o">-</span> <span class="n">original_counterfactual_example</span><span class="p">[</span><span class="n">num_pre_periods_example</span><span class="p">:])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Mocking Opt.SCopt would be needed for a runnable example here.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Assuming Opt.SCopt is available and works as expected:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># confidence_interval_example = ci_bootstrap(</span>
<span class="gp">... </span><span class="c1">#     original_weights_example, num_donors_example, donor_features_example,</span>
<span class="gp">... </span><span class="c1">#     treated_outcome_example, num_pre_periods_example, 100,</span>
<span class="gp">... </span><span class="c1">#     original_att_example, &quot;MSCb&quot;, original_counterfactual_example, confidence_level=0.90</span>
<span class="gp">... </span><span class="c1"># )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># print(confidence_interval_example) # Expected: [float, float]</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.TSEST">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">TSEST</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">donor_features_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">treated_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_bootstrap_samples</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">all_donor_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.TSEST" title="Link to this definition">#</a></dt>
<dd><p>Perform Two-Step Synthetic Control (TSSC) estimation for multiple SCM methods.</p>
<p>This function iterates through a predefined list of Synthetic Control Method
(SCM) variants (‘SIMPLEX’, ‘MSCb’, ‘MSCa’, ‘MSCc’), estimates SCM weights,
calculates treatment effects, and computes confidence intervals using
a bootstrap procedure.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>donor_features_matrix</strong> (<em>np.ndarray</em>) – Feature matrix for donor units, shape (T_total, N_features).
<cite>T_total</cite> is the total number of time periods.
<cite>N_features</cite> is the number of donor units/features.</p></li>
<li><p><strong>treated_outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit, shape (T_total,).</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods. Used for fitting the SCM weights.</p></li>
<li><p><strong>num_bootstrap_samples</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of bootstrap samples to generate for confidence interval estimation.</p></li>
<li><p><strong>all_donor_names</strong> (<em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>]</em>) – List of names corresponding to the columns (features/donors) in <cite>donor_features_matrix</cite>.
Length must be equal to <cite>N_features</cite>.</p></li>
<li><p><strong>num_post_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods. Used for calculating ATT and CIs.
Note: <cite>T_total</cite> should be <cite>num_pre_treatment_periods + num_post_treatment_periods</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>A list of dictionaries. Each dictionary corresponds to one SCM method
and has a single key (the method name, e.g., “SIMPLEX”) whose value
is another dictionary containing the detailed results for that method.
The structure of the inner dictionary is:
- “Fit” : Dict[str, float]</p>
<blockquote>
<div><p>Goodness-of-fit statistics. Keys: “RMSE_pre”, “RMSE_post”,
“R2_pre”, “R2_post”.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>”Effects”<span class="classifier">Dict[str, float]</span></dt><dd><dl class="simple">
<dt>Estimated treatment effects. Keys: “ATT” (Average Treatment Effect</dt><dd><p>on Treated for post-treatment period), “ATT_post” (same as ATT),
“ATT_pre” (average gap in pre-treatment period).</p>
</dd>
</dl>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>”95% CI”<span class="classifier">List[float]</span></dt><dd><p>A list containing two floats: <cite>[lower_bound, upper_bound]</cite> for the
95% confidence interval of the ATT.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>”Vectors”<span class="classifier">Dict[str, np.ndarray]</span></dt><dd><p>Time series vectors. Keys:
“Y” (original outcome <cite>treated_outcome_vector</cite>),
“Y_sc” (synthetic control counterfactual <cite>y_counterfactual</cite>),
“Gap” (difference <cite>Y - Y_sc</cite>),
“TimePeriods” (array of time period indices).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>”WeightV”<span class="classifier">np.ndarray</span></dt><dd><p>Raw estimated SCM weights, shape (N_features,) or (N_features+1,)
if an intercept is included by the method (e.g., “MSCa”, “MSCc”).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>”Weights”<span class="classifier">Dict[str, float]</span></dt><dd><p>Dictionary mapping donor names to their estimated weights (rounded,
non-zero weights shown). If an intercept is included, it might be
named implicitly or handled by <cite>Opt.SCopt</cite>.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>List[Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]]</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>The total number of time periods (<cite>T_total</cite>) is implicitly determined
from <cite>donor_features_matrix.shape[0]</cite> or <cite>treated_outcome_vector.shape[0]</cite>.</p></li>
<li><p>The number of features/donors (<cite>N_features</cite>) is implicitly determined
from <cite>donor_features_matrix.shape[1]</cite>.</p></li>
<li><p>This function relies on <cite>Opt.SCopt</cite> for SCM weight estimation and
<cite>ci_bootstrap</cite> for confidence interval calculation.</p></li>
<li><p>The methods run are ‘SIMPLEX’, ‘MSCb’, ‘MSCa’, ‘MSCc’.</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">T_total_example</span><span class="p">,</span> <span class="n">N_features_example</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_post_periods_example</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_features_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_total_example</span><span class="p">,</span> <span class="n">N_features_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_total_example</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_pre_periods_example</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_post_periods_example</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_names_example</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Donor_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_features_example</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">estimation_results_list</span> <span class="o">=</span> <span class="n">TSEST</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">donor_features_example</span><span class="p">,</span> <span class="n">treated_outcome_example</span><span class="p">,</span> <span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">donor_names_example</span><span class="p">,</span> <span class="n">num_post_periods_example</span>
<span class="gp">... </span><span class="p">)</span> <span class="c1"># num_bootstrap_samples=100 for example</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of methods run: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">estimation_results_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Number of methods run: 4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">first_method_name_example</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">estimation_results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results for method: </span><span class="si">{</span><span class="n">first_method_name_example</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Results for method: SIMPLEX</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">estimation_results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">first_method_name_example</span><span class="p">][</span><span class="s2">&quot;Effects&quot;</span><span class="p">][</span><span class="s2">&quot;ATT&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">estimation_results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">first_method_name_example</span><span class="p">][</span><span class="s2">&quot;Weights&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pda">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pda</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">preprocessed_data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_donors_for_fs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">pda_method_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'fs'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">l2_regularization_param_override</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pda" title="Link to this definition">#</a></dt>
<dd><p>Estimate counterfactual outcomes using Panel Data Approach (PDA) variants.</p>
<p>This function implements three PDA methods:
1. ‘fs’: Forward Selection to choose a subset of donor units.
2. ‘LASSO’: LASSO regression to select donors and estimate weights.
3. ‘l2’: L2-relaxation (Ridge-like) regression.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>preprocessed_data</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – <p>A dictionary containing preprocessed data. Expected keys are:
- ‘y’ : np.ndarray</p>
<blockquote>
<div><p>Outcome vector for the treated unit, shape (T_total,).</p>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>’donor_matrix’<span class="classifier">np.ndarray</span></dt><dd><p>Matrix of outcomes/features for donor units, shape (T_total, N_donors_original).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’donor_names’<span class="classifier">Union[pd.Index, List[str]]</span></dt><dd><p>Names of the original donor units, corresponding to columns of <cite>donor_matrix</cite>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’pre_periods’<span class="classifier">int</span></dt><dd><p>Number of pre-treatment time periods.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’post_periods’<span class="classifier">int</span></dt><dd><p>Number of post-treatment time periods.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’total_periods’<span class="classifier">int</span></dt><dd><p>Total number of time periods (<cite>pre_periods + post_periods</cite>).</p>
</dd>
</dl>
</li>
</ul>
</p></li>
<li><p><strong>num_donors_for_fs</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – <p>Number of donor units to consider.
- For ‘fs’ method: This is the maximum number of donor units to be selected</p>
<blockquote>
<div><p>by the forward selection algorithm.</p>
</div></blockquote>
<ul>
<li><p>For ‘LASSO’ and ‘l2’ methods: This parameter is not directly used by these
methods as they typically consider all available donors from <cite>preprocessed_data[‘donor_matrix’]</cite>.</p></li>
</ul>
</p></li>
<li><p><strong>pda_method_type</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) – The Panel Data Approach variant to use. Options are:
- “fs”: Forward Selection (default).
- “LASSO”: LASSO regression.
- “l2”: L2-relaxation.
Default is _PDA_METHOD_FS.</p></li>
<li><p><strong>l2_regularization_param_override</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a><em>]</em><em>, </em><em>optional</em>) – Tuning parameter for the L2-relaxation method (if <cite>pda_method_type</cite> is “l2”).
If None, the parameter is determined using cross-validation via
<cite>cross_validate_tau</cite>. Default is None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>A dictionary containing the results of the estimation. The structure
of this dictionary varies depending on the <cite>pda_method_type</cite> used:</p>
<p><strong>Common keys for all methods (derived from `effects.calculate`):</strong>
- “Effects” : Dict[str, float]</p>
<blockquote>
<div><p>Contains “ATT”, “ATT_post”, “ATT_pre”.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>”Fit”<span class="classifier">Dict[str, float]</span></dt><dd><p>Contains “RMSE_pre”, “RMSE_post”, “R2_pre”, “R2_post”.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>”Vectors”<span class="classifier">Dict[str, np.ndarray]</span></dt><dd><p>Contains “Y” (original treated outcome), “Y_sc” (counterfactual),
“Gap” (Y - Y_sc), “TimePeriods”.</p>
</dd>
</dl>
</li>
</ul>
<p><strong>Method-specific keys:</strong>
- If <cite>pda_method_type</cite> is “fs”:</p>
<blockquote>
<div><ul class="simple">
<li><p>”method”: “fs”</p></li>
<li><p>”Betas”: Dict[str, float], selected donor names to coefficients.</p></li>
<li><p>”Inference”: Dict with “t_stat”, “SE”, “95% CI”, “p_value”.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>If <cite>pda_method_type</cite> is “LASSO”:</dt><dd><ul>
<li><p>”method”: “LASSO”</p></li>
<li><p>”non_zero_coef_dict”: Dict[str, float], names of donors with
non-zero LASSO coefficients to their coefficient values.</p></li>
<li><p>”Inference”: Dict with “CI”, “t_stat”, “SE”.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>If <cite>pda_method_type</cite> is “l2”:</dt><dd><ul>
<li><p>”method”: “l2 relaxation”</p></li>
<li><p>”optimal_tau”: float, the tau value used.</p></li>
<li><p>”Betas”: Dict[str, float], all donor names to L2 coefficients.</p></li>
<li><p>”Inference”: Dict with “t_stat”, “standard_error”, “p_value”,
“confidence_interval”.</p></li>
<li><p>”Intercept”: float, the estimated intercept for L2 method.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>MlsynthConfigError</strong> – If an invalid <cite>pda_method_type</cite> is specified.</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">T</span><span class="p">,</span> <span class="n">N_orig</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N_orig</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_names_data</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;D</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_orig</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">preprocessed_data_ex</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_data</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;donor_matrix&quot;</span><span class="p">:</span> <span class="n">donor_data</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;donor_names&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">donor_names_data</span><span class="p">),</span>
<span class="gp">... </span>    <span class="s2">&quot;pre_periods&quot;</span><span class="p">:</span> <span class="n">T0</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;post_periods&quot;</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;total_periods&quot;</span><span class="p">:</span> <span class="n">T</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Forward Selection example</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results_fs</span> <span class="o">=</span> <span class="n">pda</span><span class="p">(</span><span class="n">preprocessed_data_ex</span><span class="p">,</span> <span class="n">num_donors_for_fs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pda_method_type</span><span class="o">=</span><span class="n">_PDA_METHOD_FS</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">results_fs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">])</span>
<span class="go">fs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">results_fs</span><span class="p">[</span><span class="s2">&quot;Betas&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># LASSO example</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results_lasso</span> <span class="o">=</span> <span class="n">pda</span><span class="p">(</span><span class="n">preprocessed_data_ex</span><span class="p">,</span> <span class="n">num_donors_for_fs</span><span class="o">=</span><span class="n">N_orig</span><span class="p">,</span> <span class="n">pda_method_type</span><span class="o">=</span><span class="n">_PDA_METHOD_LASSO</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">results_lasso</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">])</span>
<span class="go">LASSO</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">results_lasso</span><span class="p">[</span><span class="s2">&quot;non_zero_coef_dict&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.bartlett">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">bartlett</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lag_order</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></span><a class="headerlink" href="#mlsynth.utils.estutils.bartlett" title="Link to this definition">#</a></dt>
<dd><p>Calculate the Bartlett kernel weight for a given lag.</p>
<p>The Bartlett kernel is a common choice for HAC (Heteroskedasticity and
Autocorrelation Consistent) covariance matrix estimation. It assigns
linearly decreasing weights to autocovariances as the lag order increases,
up to a specified truncation lag.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>lag_order</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – The current lag order for which the weight is to be calculated.
Typically, <cite>lag_order</cite> ranges from 0 up to <cite>truncation_lag</cite>.</p></li>
<li><p><strong>truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – The truncation lag (bandwidth parameter). Autocovariances for lags
greater than <cite>truncation_lag</cite> receive a weight of 0.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The Bartlett kernel weight, calculated as <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">-</span> <span class="pre">|lag_order|</span> <span class="pre">/</span> <span class="pre">(truncation_lag</span> <span class="pre">+</span> <span class="pre">1)</span></code>
if <code class="docutils literal notranslate"><span class="pre">|lag_order|</span> <span class="pre">&lt;=</span> <span class="pre">truncation_lag</span></code>, and 0 otherwise.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bartlett</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bartlett</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bartlett</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">0.16666666666666663</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bartlett</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">0.0</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.hac">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">hac</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">G_moments:</span> <span class="pre">~numpy.ndarray,</span> <span class="pre">truncation_lag:</span> <span class="pre">int,</span> <span class="pre">kernel:</span> <span class="pre">~typing.Callable[[int,</span> <span class="pre">int],</span> <span class="pre">float]</span> <span class="pre">=</span> <span class="pre">&lt;function</span> <span class="pre">bartlett&gt;</span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">ndarray</span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.hac" title="Link to this definition">#</a></dt>
<dd><p>Heteroskedasticity and Autocorrelation Consistent (HAC) covariance matrix estimator.</p>
<p>This function computes the HAC covariance matrix, often used in GMM
estimation to obtain robust standard errors when moment conditions exhibit
serial correlation and/or heteroskedasticity.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>G_moments</strong> (<em>np.ndarray</em>) – Matrix of moment conditions, where rows are observations and columns
are different moment conditions. Shape (num_observations, num_moment_conditions), where
<cite>num_observations</cite> is the number of observations and <cite>num_moment_conditions</cite> is the number
of moment conditions.</p></li>
<li><p><strong>truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – The truncation lag (bandwidth parameter) for the kernel. This determines
how many autocovariance terms are included in the HAC sum.</p></li>
<li><p><strong>kernel</strong> (<em>Callable</em><em>[</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a><em>]</em><em>, </em><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a><em>]</em><em>, </em><em>optional</em>) – A kernel function that takes two integer arguments (current lag <cite>lag_order</cite>,
truncation lag <cite>truncation_lag</cite>) and returns a float weight.
Default is <cite>bartlett</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The estimated HAC covariance matrix, shape (num_moment_conditions, num_moment_conditions).</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>np.ndarray</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">num_observations_ex</span><span class="p">,</span> <span class="n">num_moment_conditions_ex</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">G_moments_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_observations_ex</span><span class="p">,</span> <span class="n">num_moment_conditions_ex</span><span class="p">)</span> <span class="c1"># Example moment conditions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">truncation_lag_ex</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Truncation lag</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">omega_hat_ex</span> <span class="o">=</span> <span class="n">hac</span><span class="p">(</span><span class="n">G_moments_ex</span><span class="p">,</span> <span class="n">truncation_lag_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">omega_hat_ex</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(2, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example with a custom kernel (e.g., Truncated/Uniform kernel)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">truncated_kernel</span><span class="p">(</span><span class="n">lag_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_truncation_lag</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lag_order</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">current_truncation_lag</span> <span class="k">else</span> <span class="mf">0.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">omega_hat_trunc_ex</span> <span class="o">=</span> <span class="n">hac</span><span class="p">(</span><span class="n">G_moments_ex</span><span class="p">,</span> <span class="n">truncation_lag_ex</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">truncated_kernel</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">omega_hat_trunc_ex</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(2, 2)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pi">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">instrument_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_periods_for_effect_eval</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">total_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">hac_truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">common_aux_covariates_1</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">common_aux_covariates_2</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pi" title="Link to this definition">#</a></dt>
<dd><p>Estimate treatment effects using a two-stage Proximal Inference approach.</p>
<p>In the first stage, coefficients (<cite>alpha</cite>) for the design matrix <cite>design_matrix</cite> are
estimated using pre-treatment data, with <cite>instrument_matrix</cite> serving as instruments for <cite>design_matrix</cite>.
In the second stage, these coefficients are used to predict counterfactual
outcomes, and the average treatment effect (<cite>tau</cite>) is estimated from the
post-treatment residuals. Standard errors for <cite>tau</cite> are computed using
a GMM framework with HAC correction.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit, shape (total_periods,).</p></li>
<li><p><strong>design_matrix</strong> (<em>np.ndarray</em>) – Design matrix (e.g., covariates for the treated unit or donor outcomes),
shape (total_periods, dim_design_matrix).</p></li>
<li><p><strong>instrument_matrix</strong> (<em>np.ndarray</em>) – Proxy matrix (instruments for <cite>design_matrix</cite> in the pre-treatment period),
shape (total_periods, dim_instrument_matrix).</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods.</p></li>
<li><p><strong>num_post_periods_for_effect_eval</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods over which the average treatment
effect (<cite>tau_mean_effect</cite>) is calculated.</p></li>
<li><p><strong>total_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Total number of time periods in <cite>outcome_vector</cite>, <cite>design_matrix</cite>, and <cite>instrument_matrix</cite>.</p></li>
<li><p><strong>hac_truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Lag length for the HAC (Heteroskedasticity and Autocorrelation Consistent)
variance estimation used for the standard error of <cite>tau_mean_effect</cite>.</p></li>
<li><p><strong>common_aux_covariates_1</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates to augment <cite>design_matrix</cite> and <cite>instrument_matrix</cite>.
If provided, <cite>common_aux_covariates_2</cite> must also be provided.
Shape (total_periods, dim_common_aux_covariates_1). Default is None.</p></li>
<li><p><strong>common_aux_covariates_2</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates to augment <cite>design_matrix</cite> and <cite>instrument_matrix</cite>.
If provided, <cite>common_aux_covariates_1</cite> must also be provided.
Shape (total_periods, dim_common_aux_covariates_2). Default is None.
Note: <cite>dim_common_aux_covariates_1</cite> and <cite>dim_common_aux_covariates_2</cite> are used to augment
both <cite>design_matrix</cite> and <cite>instrument_matrix</cite> such that they maintain the same number of columns.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>predicted_counterfactual_original_W<span class="classifier">np.ndarray</span></dt><dd><p>Predicted counterfactual outcomes for all <cite>total_periods</cite> periods, based on
the original <cite>design_matrix</cite> matrix and estimated <cite>alpha_coefficients_original_W</cite>. Shape (total_periods,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>alpha_coefficients_original_W<span class="classifier">np.ndarray</span></dt><dd><p>Estimated coefficients for the original (non-augmented) <cite>design_matrix</cite> matrix. Shape (dim_design_matrix,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>standard_error_tau_effect<span class="classifier">float</span></dt><dd><p>Standard error of the average treatment effect (<cite>tau_mean_effect</cite>).
Returns <cite>np.nan</cite> if GMM inference fails (e.g., due to singular matrix).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, np.ndarray, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>MlsynthConfigError</strong> – If augmented <cite>design_matrix</cite> and <cite>instrument_matrix</cite> matrices do not have the same number of columns.</p></li>
<li><p><strong>np.linalg.LinAlgError</strong> – If matrix inversion fails during coefficient estimation or GMM inference.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>The GMM inference for standard errors involves constructing moment conditions
based on pre-treatment orthogonality and post-treatment residuals. The
Jacobian of these moments and the HAC variance of the moment conditions
are used to compute the asymptotic variance of the parameters.</p>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">T_ex</span><span class="p">,</span> <span class="n">T0_ex</span><span class="p">,</span> <span class="n">N_W_ex</span><span class="p">,</span> <span class="n">N_Z0_ex</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">outcome_vec_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">design_mat_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_ex</span><span class="p">,</span> <span class="n">N_W_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">instr_mat_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T_ex</span><span class="p">,</span> <span class="n">N_Z0_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_post_periods_eval_ex</span> <span class="o">=</span> <span class="n">T_ex</span> <span class="o">-</span> <span class="n">T0_ex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hac_trunc_lag_ex</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Assuming design_mat_ex and instr_mat_ex have same number of columns for simplicity here</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">design_mat_ex</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">instr_mat_ex</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">se_tau</span> <span class="o">=</span> <span class="n">pi</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">outcome_vec_ex</span><span class="p">,</span> <span class="n">design_mat_ex</span><span class="p">,</span> <span class="n">instr_mat_ex</span><span class="p">,</span> <span class="n">T0_ex</span><span class="p">,</span> <span class="n">num_post_periods_eval_ex</span><span class="p">,</span> <span class="n">T_ex</span><span class="p">,</span> <span class="n">hac_trunc_lag_ex</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">se_tau</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
<span class="go">(20,) (2,) True</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pi_surrogate">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pi_surrogate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_matrix_main</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">instrument_matrix_main</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">instrument_matrix_surrogate</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surrogate_outcome_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_periods_for_effect_eval</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">total_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">hac_truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_covariates_main_1</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_covariates_main_2</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_covariates_surrogate</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pi_surrogate" title="Link to this definition">#</a></dt>
<dd><p>Estimate treatment effects using Proximal Inference with surrogate outcomes.</p>
<p>This method extends the proximal inference framework by incorporating
surrogate outcomes to potentially improve the estimation of treatment
effects, especially when the direct effect on the primary outcome is
difficult to measure in the post-treatment period.</p>
<p>The estimation involves a multi-stage process:
1. Estimate coefficients (<cite>alpha</cite>) for the main design matrix <cite>W</cite> using</p>
<blockquote>
<div><p>pre-treatment data (<cite>Y[:T0]</cite>), with <cite>Z0</cite> serving as instruments for <cite>W</cite>.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Calculate residualized outcomes (<cite>tau_hat_post = Y[T0:] - W[T0:] &#64; alpha</cite>)
for the post-treatment period. These residuals serve as a proxy for the
treatment effect.</p></li>
<li><p>Estimate coefficients (<cite>gamma</cite>) for the effect of surrogate outcomes <cite>X_surr</cite>
on <cite>tau_hat_post</cite>, using <cite>Z1</cite> as instruments for <cite>X_surr</cite> in the
post-treatment period.</p></li>
<li><p>The predicted time-varying treatment effects are then <cite>X_surr &#64; gamma</cite>.
For the pre-treatment period, <cite>taut_effects_all_periods</cite> stores the
residuals from stage 1 (<cite>Y[:T0] - W[:T0] &#64; alpha</cite>).</p></li>
<li><p>Standard errors for the average treatment effect are computed using a
GMM framework with HAC correction.</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit, shape (total_periods,).</p></li>
<li><p><strong>design_matrix_main</strong> (<em>np.ndarray</em>) – Design matrix for the main outcome equation (e.g., covariates or donor
outcomes), shape (total_periods, dim_design_matrix_main).</p></li>
<li><p><strong>instrument_matrix_main</strong> (<em>np.ndarray</em>) – Proxy matrix (instruments for <cite>design_matrix_main</cite> in the pre-treatment period),
shape (total_periods, dim_instrument_matrix_main). <cite>dim_design_matrix_main</cite> must equal <cite>dim_instrument_matrix_main</cite>.</p></li>
<li><p><strong>instrument_matrix_surrogate</strong> (<em>np.ndarray</em>) – Instruments for surrogate outcomes <cite>surrogate_outcome_matrix</cite> (used in post-treatment period),
shape (total_periods, dim_instrument_matrix_surrogate). <cite>dim_surrogate_outcome_matrix</cite> must equal <cite>dim_instrument_matrix_surrogate</cite>.</p></li>
<li><p><strong>surrogate_outcome_matrix</strong> (<em>np.ndarray</em>) – Surrogate outcomes, shape (total_periods, dim_surrogate_outcome_matrix).</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods.</p></li>
<li><p><strong>num_post_periods_for_effect_eval</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods over which the average treatment
effect (<cite>tau_mean_effect</cite>) is calculated.</p></li>
<li><p><strong>total_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Total number of time periods in <cite>outcome_vector</cite>, <cite>design_matrix_main</cite>, <cite>instrument_matrix_main</cite>, <cite>instrument_matrix_surrogate</cite>, and <cite>surrogate_outcome_matrix</cite>.</p></li>
<li><p><strong>hac_truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Lag length for the HAC (Heteroskedasticity and Autocorrelation Consistent)
variance estimation used for the standard error of <cite>tau_mean_effect</cite>.</p></li>
<li><p><strong>aux_covariates_main_1</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates for the main outcome model. If provided, <cite>aux_covariates_main_2</cite> and
<cite>aux_covariates_surrogate</cite> must also be provided. These are concatenated to both <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite>.
Shape (total_periods, dim_aux_covariates_main_1). Default is None.</p></li>
<li><p><strong>aux_covariates_main_2</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates for the main outcome model. If provided, <cite>aux_covariates_main_1</cite> and
<cite>aux_covariates_surrogate</cite> must also be provided. These are concatenated to both <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite>.
Shape (total_periods, dim_aux_covariates_main_2). Default is None.</p></li>
<li><p><strong>aux_covariates_surrogate</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates for the surrogate outcome model. If provided, <cite>aux_covariates_main_1</cite>
and <cite>aux_covariates_main_2</cite> must also be provided. These are concatenated to both <cite>surrogate_outcome_matrix</cite>
and <cite>instrument_matrix_surrogate</cite>. Shape (total_periods, dim_aux_covariates_surrogate). Default is None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>tau_mean_effect<span class="classifier">float</span></dt><dd><p>Estimated average treatment effect over the <cite>num_post_periods_for_effect_eval</cite> periods.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>taut_effects_all_periods<span class="classifier">np.ndarray</span></dt><dd><p>Time-varying treatment effects, shape (total_periods,). In the pre-treatment
period (<cite>:num_pre_treatment_periods</cite>), these are residuals from the first stage estimation
(<cite>outcome_vector[:num_pre_treatment_periods] - W_aug[:num_pre_treatment_periods] &#64; alpha_coeffs_aug</cite>). In the post-treatment
period (<cite>num_pre_treatment_periods:</cite>), these are <cite>X_surr_aug &#64; gamma_coeffs</cite>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>alpha_coeffs_orig_W<span class="classifier">np.ndarray</span></dt><dd><p>Estimated coefficients for the original (non-augmented) <cite>design_matrix_main</cite> matrix,
shape (dim_design_matrix_main,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>se_tau_effect<span class="classifier">float</span></dt><dd><p>Standard error of <cite>tau_mean_effect</cite>. Returns <cite>np.nan</cite> if GMM
inference fails (e.g., due to singular matrix).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, np.ndarray, np.ndarray, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>MlsynthConfigError</strong> – If augmented <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite> matrices (or <cite>surrogate_outcome_matrix</cite> and <cite>instrument_matrix_surrogate</cite> matrices)
    do not have the same number of columns after augmentation, or if
    the base <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite> (or <cite>surrogate_outcome_matrix</cite> and <cite>instrument_matrix_surrogate</cite>) do not have the same
    number of columns when no augmentation is applied.</p></li>
<li><p><strong>np.linalg.LinAlgError</strong> – If matrix inversion fails during coefficient estimation or GMM inference.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>It’s implicitly assumed that <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite> have the same number of columns,
and <cite>surrogate_outcome_matrix</cite> and <cite>instrument_matrix_surrogate</cite> have the same number of columns, respectively,
before any augmentation with <cite>aux_covariates_main_1</cite>, <cite>aux_covariates_main_2</cite>, <cite>aux_covariates_surrogate</cite>.</p></li>
<li><p>If <cite>aux_covariates_main_1</cite>, <cite>aux_covariates_main_2</cite>, <cite>aux_covariates_surrogate</cite> are used, they must all be provided. <cite>aux_covariates_main_1</cite> and <cite>aux_covariates_main_2</cite>
are added to both <cite>design_matrix_main</cite> and <cite>instrument_matrix_main</cite>. <cite>aux_covariates_surrogate</cite> is added to both <cite>surrogate_outcome_matrix</cite> and <cite>instrument_matrix_surrogate</cite>.</p></li>
<li><p>The GMM inference for standard errors is complex and involves constructing
moment conditions based on pre-treatment orthogonality (for <cite>alpha</cite>) and
post-treatment relationships involving surrogates (for <cite>gamma</cite> and <cite>tau</cite>).</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">num_pre_treatment_periods_ex</span><span class="p">,</span> <span class="n">N_W_Z0</span><span class="p">,</span> <span class="n">N_X_Z1</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_post_periods_for_effect_eval_ex</span> <span class="o">=</span> <span class="n">total_periods_ex</span> <span class="o">-</span> <span class="n">num_pre_treatment_periods_ex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hac_truncation_lag_ex</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">outcome_vector_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">design_matrix_main_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_W_Z0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">instrument_matrix_main_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_W_Z0</span><span class="p">)</span> <span class="c1"># Must have same N_cols as design_matrix_main_data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">instrument_matrix_surrogate_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_X_Z1</span><span class="p">)</span> <span class="c1"># Must have same N_cols as surrogate_outcome_matrix_data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">surrogate_outcome_matrix_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_X_Z1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tau</span><span class="p">,</span> <span class="n">taut</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">pi_surrogate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">outcome_vector_data</span><span class="p">,</span> <span class="n">design_matrix_main_data</span><span class="p">,</span> <span class="n">instrument_matrix_main_data</span><span class="p">,</span> <span class="n">instrument_matrix_surrogate_data</span><span class="p">,</span> <span class="n">surrogate_outcome_matrix_data</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_pre_treatment_periods_ex</span><span class="p">,</span> <span class="n">num_post_periods_for_effect_eval_ex</span><span class="p">,</span> <span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">hac_truncation_lag_ex</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg. Effect (tau): </span><span class="si">{</span><span class="n">tau</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Avg. Effect (tau): ...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time-varying effects shape: </span><span class="si">{</span><span class="n">taut</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># (30,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha coefficients shape: </span><span class="si">{</span><span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># (2,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SE of tau: </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># SE of tau: ...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example with optional covariates</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">N_aux_main_1</span><span class="p">,</span> <span class="n">N_aux_main_2</span><span class="p">,</span> <span class="n">N_aux_surr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aux_covariates_main_1_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_aux_main_1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aux_covariates_main_2_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_aux_main_2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aux_covariates_surrogate_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_aux_surr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># design_matrix_main_data and instrument_matrix_main_data still need same base N_cols.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># surrogate_outcome_matrix_data and instrument_matrix_surrogate_data still need same base N_cols.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tau_aug</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pi_surrogate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">outcome_vector_data</span><span class="p">,</span> <span class="n">design_matrix_main_data</span><span class="p">,</span> <span class="n">instrument_matrix_main_data</span><span class="p">,</span> <span class="n">instrument_matrix_surrogate_data</span><span class="p">,</span> <span class="n">surrogate_outcome_matrix_data</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_pre_treatment_periods_ex</span><span class="p">,</span> <span class="n">num_post_periods_for_effect_eval_ex</span><span class="p">,</span> <span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">hac_truncation_lag_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">aux_covariates_main_1</span><span class="o">=</span><span class="n">aux_covariates_main_1_data</span><span class="p">,</span> <span class="n">aux_covariates_main_2</span><span class="o">=</span><span class="n">aux_covariates_main_2_data</span><span class="p">,</span> <span class="n">aux_covariates_surrogate</span><span class="o">=</span><span class="n">aux_covariates_surrogate_data</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg. Effect with aug covs (tau): </span><span class="si">{</span><span class="n">tau_aug</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Avg. Effect with aug covs (tau): ...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pi_surrogate_post">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pi_surrogate_post</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">main_covariates</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">main_instruments</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surrogate_instruments</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surrogate_covariates</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">treatment_start_period</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_treatment_periods_analyzed</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">hac_truncation_lag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_main_covariates</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_main_instruments</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aux_surrogate_covariates</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pi_surrogate_post" title="Link to this definition">#</a></dt>
<dd><p>Proximal inference with post-treatment surrogates and GMM inference.</p>
<p>This function estimates treatment effects using a proximal inference
approach that leverages post-treatment surrogate outcomes. Unlike <cite>pi_surrogate</cite>
which uses pre-treatment data to estimate initial coefficients, this method
focuses on the post-treatment period for estimating the relationship between
outcomes, covariates, and surrogates.</p>
<p>The core idea is to model the outcome <cite>outcome_vector</cite> in the post-treatment period as a
function of pre-treatment covariates <cite>main_covariates</cite> and post-treatment surrogates
<cite>surrogate_covariates</cite>, using <cite>main_instruments</cite> and <cite>surrogate_instruments</cite> as corresponding
instruments. The coefficients for <cite>surrogate_covariates</cite> (<cite>gamma_coeffs_surr</cite>)
are interpreted as the effect of surrogates on the outcome, and
<cite>surrogate_covariates &#64; gamma_coeffs_surr</cite> gives the time-varying treatment effects.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outcome_vector</strong> (<em>np.ndarray</em>) – Outcome variable, shape (total_periods,).</p></li>
<li><p><strong>main_covariates</strong> (<em>np.ndarray</em>) – Pre-treatment covariates, shape (total_periods, dim_main_covariates).</p></li>
<li><p><strong>main_instruments</strong> (<em>np.ndarray</em>) – Instruments for <cite>main_covariates</cite>, shape (total_periods, dim_main_instruments). <cite>dim_main_covariates</cite> must equal <cite>dim_main_instruments</cite>.</p></li>
<li><p><strong>surrogate_instruments</strong> (<em>np.ndarray</em>) – Instruments for surrogate outcomes <cite>surrogate_covariates</cite>, shape (total_periods, dim_surrogate_instruments).
<cite>dim_surrogate_covariates</cite> must equal <cite>dim_surrogate_instruments</cite>.</p></li>
<li><p><strong>surrogate_covariates</strong> (<em>np.ndarray</em>) – Post-treatment covariates/surrogates, shape (total_periods, dim_surrogate_covariates).</p></li>
<li><p><strong>treatment_start_period</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Time period index when treatment starts (0-indexed).</p></li>
<li><p><strong>num_post_treatment_periods_analyzed</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Length of the post-treatment period to be used for analysis.
The analysis window will be <cite>outcome_vector[treatment_start_period : treatment_start_period + num_post_treatment_periods_analyzed]</cite>.</p></li>
<li><p><strong>hac_truncation_lag</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Lag parameter for HAC (Heteroskedasticity and Autocorrelation Consistent)
covariance estimation for standard errors.</p></li>
<li><p><strong>aux_main_covariates</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates to augment <cite>main_covariates</cite>. If provided, <cite>aux_main_instruments</cite> and <cite>aux_surrogate_covariates</cite>
must also be provided. Shape (total_periods, dim_aux_main_covariates). Default is None.</p></li>
<li><p><strong>aux_main_instruments</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates to augment <cite>main_instruments</cite> (and implicitly <cite>surrogate_instruments</cite>
if they relate to <cite>outcome_vector</cite>). If provided, <cite>aux_main_covariates</cite> and <cite>aux_surrogate_covariates</cite> must also be
provided. Shape (total_periods, dim_aux_main_instruments). Default is None.</p></li>
<li><p><strong>aux_surrogate_covariates</strong> (<em>Optional</em><em>[</em><em>np.ndarray</em><em>]</em><em>, </em><em>optional</em>) – Additional covariates to augment <cite>surrogate_covariates</cite> (and <cite>surrogate_instruments</cite>).
If provided, <cite>aux_main_covariates</cite> and <cite>aux_main_instruments</cite> must also be provided.
Shape (total_periods, dim_aux_surrogate_covariates). Default is None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>tau_mean_effect<span class="classifier">float</span></dt><dd><p>Estimated average treatment effect over the specified post-treatment period.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>taut_varying_effects<span class="classifier">np.ndarray</span></dt><dd><p>Time-varying treatment effect estimates for all <cite>total_periods</cite> periods,
calculated as <cite>X_ext_aug &#64; gamma_coeffs_surr</cite>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>params_W_coeffs<span class="classifier">np.ndarray</span></dt><dd><p>Estimated coefficients for the original (non-augmented) <cite>main_covariates</cite> matrix.
Shape (dim_main_covariates,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>se_tau_effect<span class="classifier">float</span></dt><dd><p>Standard error of <cite>tau_mean_effect</cite>. Returns <cite>np.nan</cite> if GMM
inference fails.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, np.ndarray, np.ndarray, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>MlsynthConfigError</strong> – If there’s a dimension mismatch in the combined instrument and covariate
    matrices after potential augmentation, or if base matrices have mismatches.</p></li>
<li><p><strong>np.linalg.LinAlgError</strong> – If matrix inversion fails during coefficient estimation or GMM inference.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>The augmentation logic for <cite>Cw_cov</cite>, <cite>Cy_cov</cite>, <cite>Cx_cov</cite> combines these into
<cite>Z_combined_aug</cite> and <cite>WX_combined_aug</cite>. The exact structure of this
combination (especially the order) is critical and follows the original
implementation’s implicit logic.</p></li>
<li><p><cite>X_ext_aug</cite> refers to <cite>X_post_covars</cite> potentially augmented by <cite>Cx_cov</cite>.</p></li>
<li><p>The GMM inference for standard errors is based on moment conditions
derived from the post-treatment estimation.</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">treatment_start_period_ex</span><span class="p">,</span> <span class="n">num_post_treatment_periods_analyzed_ex</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">N_main_cov_ex</span><span class="p">,</span> <span class="n">N_main_instr_ex</span><span class="p">,</span> <span class="n">N_surr_cov_ex</span><span class="p">,</span> <span class="n">N_surr_instr_ex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hac_truncation_lag_ex</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">outcome_vector_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">main_covariates_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_main_cov_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">main_instruments_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_main_instr_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">surrogate_instruments_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_surr_instr_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">surrogate_covariates_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_ex</span><span class="p">,</span> <span class="n">N_surr_cov_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tau_val</span><span class="p">,</span> <span class="n">taut_val</span><span class="p">,</span> <span class="n">alpha_W_val</span><span class="p">,</span> <span class="n">se_val</span> <span class="o">=</span> <span class="n">pi_surrogate_post</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">outcome_vector_ex</span><span class="p">,</span> <span class="n">main_covariates_ex</span><span class="p">,</span> <span class="n">main_instruments_ex</span><span class="p">,</span> <span class="n">surrogate_instruments_ex</span><span class="p">,</span> <span class="n">surrogate_covariates_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">treatment_start_period</span><span class="o">=</span><span class="n">treatment_start_period_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">num_post_treatment_periods_analyzed</span><span class="o">=</span><span class="n">num_post_treatment_periods_analyzed_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">hac_truncation_lag</span><span class="o">=</span><span class="n">hac_truncation_lag_ex</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated ATT: </span><span class="si">{</span><span class="n">tau_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Estimated ATT: ...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SE of ATT: </span><span class="si">{</span><span class="n">se_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">SE of ATT: ...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of W coefficients: </span><span class="si">{</span><span class="n">alpha_W_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Shape of W coefficients: (2,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of time-varying effects: </span><span class="si">{</span><span class="n">taut_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Shape of time-varying effects: (30,)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.get_theta">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">get_theta</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">treated_outcome_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.get_theta" title="Link to this definition">#</a></dt>
<dd><p>Calculate alignment coefficients (theta) and the aligned donor matrix.</p>
<p>This function is a helper for the Synthetic Regressing Control (SRC) method.
It computes alignment coefficients <cite>alignment_coefficients</cite> for each donor unit based on
pre-treatment data. These coefficients aim to align each donor’s outcome
series with the treated unit’s outcome series by scaling the demeaned
donor outcomes.</p>
<p>The alignment coefficient for each donor <cite>j</cite> is calculated as:</p>
<p><code class="docutils literal notranslate"><span class="pre">theta_j</span> <span class="pre">=</span> <span class="pre">(donor_outcomes_pre_treatment_demeaned_j'</span> <span class="pre">&#64;</span> <span class="pre">treated_outcome_pre_treatment_demeaned)</span> <span class="pre">/</span> <span class="pre">(donor_outcomes_pre_treatment_demeaned_j'</span> <span class="pre">&#64;</span> <span class="pre">donor_outcomes_pre_treatment_demeaned_j)</span></code></p>
<p>where <code class="docutils literal notranslate"><span class="pre">donor_outcomes_pre_treatment_demeaned_j</span></code> is the demeaned outcome series for donor <cite>j</cite> in the
pre-treatment period, and <code class="docutils literal notranslate"><span class="pre">treated_outcome_pre_treatment_demeaned</span></code> is the demeaned outcome series for
the treated unit in the pre-treatment period.</p>
<p>The aligned donor matrix <cite>aligned_donor_outcomes_pre_treatment</cite> is then <cite>donor_outcomes_pre_treatment * alignment_coefficients</cite>,
where the multiplication is element-wise broadcasted.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>treated_outcome_pre_treatment</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit in the pre-treatment period,
shape (T0,), where T0 is the number of pre-treatment periods.</p></li>
<li><p><strong>donor_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Matrix of outcomes for donor units in the pre-treatment period,
shape (T0, J), where J is the number of donor units.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>alignment_coefficients<span class="classifier">np.ndarray</span></dt><dd><p>Vector of estimated alignment coefficients for each donor unit,
shape (J,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>aligned_donor_outcomes_pre_treatment<span class="classifier">np.ndarray</span></dt><dd><p>The donor matrix <cite>donor_outcomes_pre_treatment</cite> with each column scaled by its
corresponding <cite>alignment_coefficients</cite> coefficient, shape (T0, J).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, np.ndarray]</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">T0_ex</span><span class="p">,</span> <span class="n">J_ex</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_pre_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T0_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_outcomes_pre_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">T0_ex</span><span class="p">,</span> <span class="n">J_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">theta_coeffs</span><span class="p">,</span> <span class="n">Y_aligned</span> <span class="o">=</span> <span class="n">get_theta</span><span class="p">(</span><span class="n">treated_outcome_pre_ex</span><span class="p">,</span> <span class="n">donor_outcomes_pre_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">theta_coeffs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(3,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Y_aligned</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(10, 3)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.get_sigmasq">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">get_sigmasq</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">treated_outcome_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></span><a class="headerlink" href="#mlsynth.utils.estutils.get_sigmasq" title="Link to this definition">#</a></dt>
<dd><p>Estimate noise variance (sigma^2) for the Synthetic Regressing Control (SRC) method.</p>
<p>This function estimates the variance of the noise term in the conceptual model
<code class="docutils literal notranslate"><span class="pre">treated_outcome</span> <span class="pre">=</span> <span class="pre">donor_outcomes</span> <span class="pre">*</span> <span class="pre">alignment_coefficients</span> <span class="pre">+</span> <span class="pre">error_term</span></code>,
where <code class="docutils literal notranslate"><span class="pre">error_term</span></code> is assumed to be white noise with variance <code class="docutils literal notranslate"><span class="pre">sigma**2</span></code>.
The estimation is based on the residuals obtained after projecting the
demeaned pre-treatment outcome of the treated unit (<cite>treated_outcome_pre_treatment</cite>)
onto the space spanned by the demeaned pre-treatment outcomes of the donor
units (<cite>donor_outcomes_pre_treatment</cite>).</p>
<p>The projection involves a <cite>demeaning_matrix</cite> and a <cite>donor_based_projection_matrix</cite>
derived from <cite>donor_outcomes_pre_treatment</cite>. The residual error is effectively
<cite>demeaning_matrix &#64; treated_outcome_pre_treatment - demeaning_matrix &#64; donor_based_projection_matrix &#64; demeaning_matrix &#64; treated_outcome_pre_treatment</cite>,
and the noise variance (<cite>sigma^2</cite>) is estimated as the squared L2-norm of this residual error.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>treated_outcome_pre_treatment</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit in the pre-treatment period,
shape (num_pre_treatment_periods,), where num_pre_treatment_periods is the number of pre-treatment periods.</p></li>
<li><p><strong>donor_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Matrix of outcomes for donor units in the pre-treatment period,
shape (num_pre_treatment_periods, num_donors), where num_donors is the number of donor units.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Estimated noise variance (<cite>sigma^2</cite>).</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_pre_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_outcomes_pre_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">noise_variance_estimate_example</span> <span class="o">=</span> <span class="n">get_sigmasq</span><span class="p">(</span><span class="n">treated_outcome_pre_example</span><span class="p">,</span> <span class="n">donor_outcomes_pre_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated sigma^2: </span><span class="si">{</span><span class="n">noise_variance_estimate_example</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Estimated sigma^2: ...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.SRCest">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">SRCest</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">treated_outcome_full_period</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_full_period</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.SRCest" title="Link to this definition">#</a></dt>
<dd><p>Estimate counterfactual outcomes using the Synthetic Regressing Control (SRC) method.</p>
<p>The SRC method involves three main steps:
1.  <strong>Alignment Coefficient Estimation (`get_theta`):</strong> Estimate alignment</p>
<blockquote>
<div><p>coefficients (<cite>estimated_alignment_coefficients</cite>) for each donor unit by regressing the demeaned
pre-treatment outcome of the treated unit on the demeaned pre-treatment
outcomes of each donor unit individually.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p><strong>Noise Variance Estimation (`get_sigmasq`):</strong> Estimate the variance
(<cite>estimated_noise_variance</cite>) of the noise in the relationship between the treated unit’s
outcome and the aligned donor outcomes in the pre-treatment period.</p></li>
<li><p><strong>Weight Optimization and Prediction (`__SRC_opt`):</strong> Solve an optimization
problem to find donor weights (<cite>optimal_donor_weights_result</cite>) that minimize a penalized sum of
squared errors between the treated unit’s pre-treatment outcomes and the
weighted sum of aligned donor outcomes. The penalty term involves <cite>estimated_noise_variance</cite>.
These weights are then used to construct the counterfactual outcome series
for both pre-treatment (in-sample prediction) and post-treatment periods.</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>treated_outcome_full_period</strong> (<em>np.ndarray</em>) – Outcomes for the treated unit across all time periods, shape (total_time_periods,).
<cite>total_time_periods</cite> is the total number of time periods.</p></li>
<li><p><strong>donor_outcomes_full_period</strong> (<em>np.ndarray</em>) – Outcomes for donor units across all time periods, shape (total_time_periods, num_donors).
<cite>num_donors</cite> is the number of donor units.</p></li>
<li><p><strong>num_post_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods. The number of pre-treatment periods
(num_pre_treatment_periods) is inferred as <cite>total_time_periods - num_post_treatment_periods</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>counterfactual_full_period<span class="classifier">np.ndarray</span></dt><dd><p>The estimated counterfactual outcome series for the treated unit
across all <cite>total_time_periods</cite> periods, shape (total_time_periods,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>optimal_donor_weights_result<span class="classifier">np.ndarray</span></dt><dd><p>The optimal weights assigned to each donor unit, shape (num_donors,).
These weights sum to 1 and are non-negative.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>estimated_alignment_coefficients<span class="classifier">np.ndarray</span></dt><dd><p>The estimated alignment coefficients for each donor unit, shape (num_donors,).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, np.ndarray, np.ndarray]</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_post_periods_example</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">treated_outcome_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_outcomes_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span><span class="p">)</span> <span class="o">+</span>     <span class="o">...</span>                          <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span>     <span class="o">...</span>                          <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_donors_example</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">counterfactual_est</span><span class="p">,</span> <span class="n">weights_est</span><span class="p">,</span> <span class="n">theta_est</span> <span class="o">=</span> <span class="n">SRCest</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">treated_outcome_example</span><span class="p">,</span> <span class="n">donor_outcomes_example</span><span class="p">,</span> <span class="n">num_post_periods_example</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counterfactual shape: </span><span class="si">{</span><span class="n">counterfactual_est</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Counterfactual shape: (20,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights shape: </span><span class="si">{</span><span class="n">weights_est</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Weights shape: (4,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Theta coefficients shape: </span><span class="si">{</span><span class="n">theta_est</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Theta coefficients shape: (4,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of weights: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_est</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be close to 1</span>
<span class="go">Sum of weights: 1.00</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.RPCASYNTH">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">RPCASYNTH</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">panel_dataframe</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">DataFrame</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimation_config</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">preprocessed_data_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.RPCASYNTH" title="Link to this definition">#</a></dt>
<dd><p>Robust Principal Component Analysis Synthetic Control (RPCASYNTH).</p>
<p>This method combines Robust PCA with Synthetic Control. It first performs
functional PCA-based clustering on pre-treatment outcomes to identify a
relevant donor pool. Then, Robust PCA (either PCP or HQF) is applied to
the outcomes of these clustered donors. Finally, Synthetic Control Method
weights are estimated using the low-rank representation of the donors from
RPCA, and these weights are used to construct the counterfactual.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>panel_dataframe</strong> (<em>pd.DataFrame</em>) – Panel data, typically in long format, containing outcomes for all units
over time. It will be pivoted to a wide format internally. Must contain
columns specified by <cite>estimation_config[‘unitid’]</cite>, <cite>estimation_config[‘time’]</cite>, and
<cite>estimation_config[‘outcome’]</cite>.</p></li>
<li><p><strong>estimation_config</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – <p>Configuration dictionary for the estimation. Expected keys are:
- ‘unitid’ : str</p>
<blockquote>
<div><p>Column name in <cite>panel_dataframe</cite> identifying unique units.</p>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>’time’<span class="classifier">str</span></dt><dd><p>Column name in <cite>panel_dataframe</cite> identifying time periods.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’outcome’<span class="classifier">str</span></dt><dd><p>Column name in <cite>panel_dataframe</cite> for the outcome variable.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’ROB’<span class="classifier">str, optional</span></dt><dd><p>Robust PCA method to use. Options are ‘PCP’ (Principal Component
Pursuit) or ‘HQF’ (High Quality Factorization). Defaults to ‘PCP’
if not provided in <cite>estimation_config</cite>.</p>
</dd>
</dl>
</li>
</ul>
</p></li>
<li><p><strong>preprocessed_data_dict</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – <p>A dictionary containing preprocessed data, typically output from a data
preparation utility. Expected keys are:
- ‘treated_unit_name’ : Union[str, int]</p>
<blockquote>
<div><p>Identifier of the treated unit. Must match a value in
<cite>panel_dataframe[estimation_config[‘unitid’]]</cite>.</p>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>’pre_periods’<span class="classifier">int</span></dt><dd><p>Number of pre-treatment time periods. Used to slice the data for
fitting various components (clustering, RPCA, SCM).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’post_periods’<span class="classifier">int</span></dt><dd><p>Number of post-treatment time periods. Used for calculating effects.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’y’<span class="classifier">np.ndarray</span></dt><dd><p>Outcome vector for the treated unit across all time periods (pre and
post). Shape (total_time_periods,). This is used by <cite>effects.calculate</cite> as the
observed series for the treated unit.</p>
</dd>
</dl>
</li>
</ul>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>A dictionary containing the estimation results. The keys are:
- ‘name’ : str</p>
<blockquote>
<div><p>The name of the method, set to ‘RPCA’.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>’weights’<span class="classifier">Dict[str, float]</span></dt><dd><p>A dictionary mapping donor names (from the selected cluster,
excluding the treated unit) to their estimated SCM weights. Only
non-zero weights (rounded to 3 decimal places, absolute value &gt; 0.001)
are included.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’Effects’<span class="classifier">Dict[str, float]</span></dt><dd><p>Dictionary of treatment effect estimates (e.g., ‘ATT’, ‘ATT_post’,
‘ATT_pre’) as returned by <cite>effects.calculate</cite>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’Fit’<span class="classifier">Dict[str, float]</span></dt><dd><p>Dictionary of goodness-of-fit statistics (e.g., ‘RMSE_pre’, ‘R2_pre’)
as returned by <cite>effects.calculate</cite>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>’Vectors’<span class="classifier">Dict[str, np.ndarray]</span></dt><dd><p>Dictionary of time series vectors (e.g., ‘Y’ (original treated
outcome from <cite>preprocessed_data_dict[‘y’]</cite>), ‘Y_sc’ (synthetic counterfactual),
‘Gap’, ‘TimePeriods’) as returned by <cite>effects.calculate</cite>.</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create sample data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data_example</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;id_col&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;time_col&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2001</span><span class="p">,</span><span class="mi">2002</span><span class="p">,</span><span class="mi">2003</span><span class="p">,</span><span class="mi">2004</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">&#39;outcome_val&#39;</span><span class="p">:</span> <span class="p">(</span>
<span class="gp">... </span>        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">])</span> <span class="o">+</span>  <span class="c1"># Unit 1 (Treated)</span>
<span class="gp">... </span>        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">])</span> <span class="o">+</span>  <span class="c1"># Unit 2</span>
<span class="gp">... </span>        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">])</span> <span class="o">+</span>  <span class="c1"># Unit 3</span>
<span class="gp">... </span>        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">])</span>    <span class="c1"># Unit 4</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">panel_df_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">config_example</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;unitid&#39;</span><span class="p">:</span> <span class="s1">&#39;id_col&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_col&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;outcome_val&#39;</span><span class="p">,</span> <span class="s1">&#39;ROB&#39;</span><span class="p">:</span> <span class="s1">&#39;PCP&#39;</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y_treated_example</span> <span class="o">=</span> <span class="n">panel_df_example</span><span class="p">[</span><span class="n">panel_df_example</span><span class="p">[</span><span class="s1">&#39;id_col&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;outcome_val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">preproc_data_example</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;treated_unit_name&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pre_periods&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;post_periods&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_treated_example</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results_rpca_example</span> <span class="o">=</span> <span class="n">RPCASYNTH</span><span class="p">(</span><span class="n">panel_df_example</span><span class="p">,</span> <span class="n">config_example</span><span class="p">,</span> <span class="n">preproc_data_example</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">results_rpca_example</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
<span class="go">RPCA</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">results_rpca_example</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ATT: </span><span class="si">{</span><span class="n">results_rpca_example</span><span class="p">[</span><span class="s1">&#39;Effects&#39;</span><span class="p">][</span><span class="s1">&#39;ATT&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Example output</span>
<span class="go">ATT: ...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.SMOweights">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">SMOweights</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">multi_outcome_data_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aggregation_method</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'concatenated'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods_override</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">ndarray</span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.SMOweights" title="Link to this definition">#</a></dt>
<dd><p>Estimate Synthetic Control Method (SCM) weights for Multiple Outcomes (SMO).</p>
<p>This function calculates SCM weights when there are multiple outcome variables
for the treated unit and donor units. It supports two approaches for
combining information across outcomes:
1.  ‘concatenated’: Stacks the outcome series (treated and donors) for all</p>
<blockquote>
<div><p>outcomes into single long vectors/matrices before solving the SCM
optimization problem. This is akin to the Time-series, Likelihood,
Penalized (TLP) approach.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>‘average’: Averages the demeaned outcome series (treated and donors)
across all outcomes before solving the SCM optimization. This resembles
a Sparse Bayesian Model Averaging Framework (SBMF) like objective.</p></li>
</ol>
<p>The optimization problem minimizes the sum of squared differences between
the (potentially transformed) treated unit’s outcomes and the weighted sum
of donor outcomes, subject to weights being non-negative and summing to 1.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>multi_outcome_data_dict</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>List</em><em>[</em><em>np.ndarray</em><em>]</em><em>]</em>) – <p>A dictionary containing the data for multiple outcomes. It must have
two keys: ‘Target’ and ‘Donors’.
- ‘Target’ : List[np.ndarray]</p>
<blockquote>
<div><p>A list where each element is a 1D NumPy array representing the
outcome series for one of the K outcomes of the treated unit.
Each array should have shape (total_time_periods,), where total_time_periods is the
total number of time periods.</p>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>’Donors’<span class="classifier">List[np.ndarray]</span></dt><dd><p>A list where each element is a 2D NumPy array representing the
outcomes of donor units for the corresponding outcome in ‘Target’.
Each array should have shape (total_time_periods, num_donors), where num_donors
is the number of donor units. All donor matrices in the list must
have the same number of columns (num_donors) and rows (total_time_periods).</p>
</dd>
</dl>
</li>
</ul>
</p></li>
<li><p><strong>aggregation_method</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) – The method to use for combining information across multiple outcomes.
Options are:
- ‘concatenated’: Stacks data from all outcomes. (Default)
- ‘average’: Averages demeaned data across outcomes.
Default is “concatenated”.</p></li>
<li><p><strong>num_pre_treatment_periods_override</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a><em>]</em><em>, </em><em>optional</em>) – The number of pre-treatment periods to use for fitting the SCM weights.
If None, all time periods in the input data are considered as
pre-treatment. Default is None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>An array containing the optimal SCM weights for the donor units.
The shape of the array is (num_donors,). These weights are non-negative
and sum to 1.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>np.ndarray</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>MlsynthDataError</strong> – If <cite>multi_outcome_data_dict</cite> is not structured correctly (e.g., ‘Target’ or ‘Donors’
    are not lists of NumPy arrays, lists have different lengths, or lists are empty).</p></li>
<li><p><strong>MlsynthConfigError</strong> – If an invalid <cite>aggregation_method</cite> is specified.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span><span class="p">,</span> <span class="n">num_outcomes_example</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_example</span> <span class="o">=</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">target_outcomes_list_example</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_outcomes_example</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">donor_outcomes_list_example</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">total_periods_example</span><span class="p">,</span> <span class="n">num_donors_example</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_outcomes_example</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data_dict_example</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Target&quot;</span><span class="p">:</span> <span class="n">target_outcomes_list_example</span><span class="p">,</span> <span class="s2">&quot;Donors&quot;</span><span class="p">:</span> <span class="n">donor_outcomes_list_example</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using &#39;concatenated&#39; method</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights_concat_example</span> <span class="o">=</span> <span class="n">SMOweights</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">data_dict_example</span><span class="p">,</span> <span class="n">aggregation_method</span><span class="o">=</span><span class="s2">&quot;concatenated&quot;</span><span class="p">,</span> <span class="n">num_pre_treatment_periods_override</span><span class="o">=</span><span class="n">num_pre_periods_example</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concatenated weights shape: </span><span class="si">{</span><span class="n">weights_concat_example</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Concatenated weights shape: (3,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of weights: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_concat_example</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Sum of weights: 1.00</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using &#39;average&#39; method</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights_avg_example</span> <span class="o">=</span> <span class="n">SMOweights</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">data_dict_example</span><span class="p">,</span> <span class="n">aggregation_method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span> <span class="n">num_pre_treatment_periods_override</span><span class="o">=</span><span class="n">num_pre_periods_example</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average weights shape: </span><span class="si">{</span><span class="n">weights_avg_example</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Average weights shape: (3,)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.NSC_opt">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">NSC_opt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pre_treatment_treated_outcome</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre_treatment_donor_outcomes</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">l1_discrepancy_penalty_factor</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">l2_penalty_factor</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">ndarray</span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.NSC_opt" title="Link to this definition">#</a></dt>
<dd><p>Normalized Synthetic Control (NSC) weight optimization.</p>
<p>Solves for weights minimizing error between treated unit’s outcome (pre_treatment_treated_outcome)
and an affine combination of control units’ outcomes (pre_treatment_donor_outcomes),
subject to regularization.</p>
<p>The optimization problem is:</p>
<p><code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">||pre_treatment_treated_outcome</span> <span class="pre">-</span> <span class="pre">pre_treatment_donor_outcomes</span> <span class="pre">&#64;</span> <span class="pre">donor_weights_cvxpy_var||_2**2</span> <span class="pre">+</span>
<span class="pre">l1_discrepancy_penalty_factor</span> <span class="pre">*</span> <span class="pre">sum(|donor_weights_cvxpy_var_j|</span> <span class="pre">*</span> <span class="pre">discrepancy_j)</span> <span class="pre">+</span>
<span class="pre">l2_penalty_factor</span> <span class="pre">*</span> <span class="pre">||donor_weights_cvxpy_var||_2**2</span></code></p>
<p>subject to <code class="docutils literal notranslate"><span class="pre">sum(donor_weights_cvxpy_var)</span> <span class="pre">==</span> <span class="pre">1</span></code>.
The <code class="docutils literal notranslate"><span class="pre">discrepancy_j</span></code> is the L2 norm of the difference between <code class="docutils literal notranslate"><span class="pre">pre_treatment_treated_outcome</span></code>
and the j-th donor’s outcome series <code class="docutils literal notranslate"><span class="pre">pre_treatment_donor_outcomes[:,</span> <span class="pre">j]</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>pre_treatment_treated_outcome</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit in the pre-treatment periods.
Shape (T0,), where T0 is the number of pre-treatment periods.</p></li>
<li><p><strong>pre_treatment_donor_outcomes</strong> (<em>np.ndarray</em>) – Matrix of outcomes for control (donor) units in the pre-treatment periods.
Shape (T0, num_donors), where num_donors is the number of donor units.</p></li>
<li><p><strong>l1_discrepancy_penalty_factor</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Regularization parameter for the L1 penalty term on weights, scaled by
the pairwise discrepancy between the treated unit and each donor unit.
This term encourages sparsity and favors donors similar to the treated unit.</p></li>
<li><p><strong>l2_penalty_factor</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Regularization parameter for the L2 penalty term on weights (Ridge-like
regularization). This term helps to stabilize the solution and prevent
overfitting.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>An array containing the computed optimal weights for the control units.
Shape (num_donors,). The weights are constrained to sum to 1.
Returns an array of NaNs of shape (num_donors,) if the optimization
does not converge to an optimal or optimal_inaccurate solution.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>np.ndarray</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>The CVXPY library with the CLARABEL solver is used for optimization.</p></li>
<li><p>A warning is issued if the optimization fails to converge.</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_ex</span><span class="p">,</span> <span class="n">num_donors_ex</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pre_treatment_treated_outcome_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pre_treatment_donor_outcomes_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_ex</span><span class="p">,</span> <span class="n">num_donors_ex</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l1_penalty_factor_ex</span><span class="p">,</span> <span class="n">l2_penalty_factor_ex</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">optimal_weights_ex</span> <span class="o">=</span> <span class="n">NSC_opt</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">pre_treatment_treated_outcome_ex</span><span class="p">,</span> <span class="n">pre_treatment_donor_outcomes_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">l1_penalty_factor_ex</span><span class="p">,</span> <span class="n">l2_penalty_factor_ex</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">optimal_weights_ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">optimal_weights_ex</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSC weights shape: </span><span class="si">{</span><span class="n">optimal_weights_ex</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of weights: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimal_weights_ex</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">NSC weights shape: (4,)</span>
<span class="go">Sum of weights: 1.00</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.NSCcv">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">NSCcv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">actual_treated_outcome_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">all_donors_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">a_vals</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">b_vals</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_cv_folds</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">5</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.NSCcv" title="Link to this definition">#</a></dt>
<dd><p>K-fold cross-validation for Normalized Synthetic Control (NSC).</p>
<p>Selects the best tuning parameters <cite>l1_discrepancy_penalty_factor</cite> (a_reg)
and <cite>l2_penalty_factor</cite> (b_reg) for the Normalized Synthetic Control (NSC)
method using k-fold cross-validation.</p>
<p>The cross-validation process iterates through combinations of penalty factors
from the provided grids. For each combination, it performs k-fold
cross-validation on the donor units. In each fold, a subset of donors is
held out for validation, and <cite>NSC_opt</cite> is used to fit weights to reconstruct
each validation donor using the remaining training donors. The penalty factors
that yield the minimum average mean squared error (MSE) across folds are
selected as optimal.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>actual_treated_outcome_pre_treatment</strong> (<em>np.ndarray</em>) – Outcome vector for the actual treated unit in the pre-treatment periods.
Shape (T0,), where T0 is the number of pre-treatment periods. This is
used by <cite>NSC_opt</cite> internally to calculate discrepancies when fitting
weights to reconstruct pseudo-treated (validation) donors.</p></li>
<li><p><strong>all_donors_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Matrix of outcomes for all control (donor) units in the pre-treatment
periods. Shape (T0, total_num_donors), where total_num_donors is the total number of
donor units available for cross-validation.</p></li>
<li><p><strong>l1_penalty_grid</strong> (<em>np.ndarray</em><em>, </em><em>optional</em>) – A 1D NumPy array specifying the grid of values for the L1 discrepancy
penalty factor (<cite>l1_discrepancy_penalty_factor</cite>) to be tested.
Default is <cite>np.arange(0.01, 1.01, 0.05)</cite>.</p></li>
<li><p><strong>l2_penalty_grid</strong> (<em>np.ndarray</em><em>, </em><em>optional</em>) – A 1D NumPy array specifying the grid of values for the L2 penalty
factor (<cite>l2_penalty_factor</cite>) to be tested.
Default is <cite>np.arange(0.01, 1.01, 0.05)</cite>.</p></li>
<li><p><strong>num_cv_folds</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a><em>, </em><em>optional</em>) – The number of folds to use for cross-validation. Default is 5.
The actual number of folds will be <cite>min(num_cv_folds, total_num_donors)</cite>.
If the actual number of folds is less than 2, default penalty factors
(0.01, 0.01) are returned with a warning.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>A tuple containing the optimal <cite>l1_discrepancy_penalty_factor</cite> and
<cite>l2_penalty_factor</cite> values found:
- optimal_l1_penalty : float</p>
<blockquote>
<div><p>The value from <cite>l1_penalty_grid</cite> that, in combination with
<cite>optimal_l2_penalty</cite>, resulted in the lowest average cross-validation MSE.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>optimal_l2_penalty<span class="classifier">float</span></dt><dd><p>The value from <cite>l2_penalty_grid</cite> that, in combination with
<cite>optimal_l1_penalty</cite>, resulted in the lowest average cross-validation MSE.</p>
</dd>
</dl>
</li>
</ul>
<p>If CV cannot be run meaningfully (e.g., too few donors) or no valid
parameters are found, defaults (0.01, 0.01) are returned.</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)">float</a>]</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>The cross-validation is performed by treating each donor unit (or group of
donors in a fold) as a pseudo-treated unit and attempting to reconstruct
its pre-treatment outcome series using the remaining donors.</p></li>
<li><p>The <cite>actual_treated_outcome_pre_treatment</cite> (i.e., the outcome of the <em>actual</em>
treated unit) is used within <cite>NSC_opt</cite> to calculate the discrepancy term.
This means the discrepancy penalty is always relative to the actual treated unit,
even when reconstructing a pseudo-treated (validation) donor. This is a specific
choice in this CV implementation. An alternative would be to calculate discrepancy
relative to the current pseudo-treated unit.</p></li>
</ul>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">num_pre_periods_ex</span><span class="p">,</span> <span class="n">total_num_donors_ex</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">actual_treated_pre_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_ex</span><span class="p">)</span> <span class="c1"># Actual treated unit&#39;s data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">all_donors_pre_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_pre_periods_ex</span><span class="p">,</span> <span class="n">total_num_donors_ex</span><span class="p">)</span> <span class="c1"># All donors&#39; data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l1_grid_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l2_grid_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">best_l1</span><span class="p">,</span> <span class="n">best_l2</span> <span class="o">=</span> <span class="n">NSCcv</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">actual_treated_pre_ex</span><span class="p">,</span> <span class="n">all_donors_pre_ex</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">a_vals</span><span class="o">=</span><span class="n">l1_grid_ex</span><span class="p">,</span> <span class="n">b_vals</span><span class="o">=</span><span class="n">l2_grid_ex</span><span class="p">,</span> <span class="n">num_cv_folds</span><span class="o">=</span><span class="mi">3</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best L1 penalty: </span><span class="si">{</span><span class="n">best_l1</span><span class="si">}</span><span class="s2">, Best L2 penalty: </span><span class="si">{</span><span class="n">best_l2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Best L1 penalty: ..., Best L2 penalty: ...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.pcr">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">pcr</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">donor_outcomes_matrix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">treated_unit_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scm_objective_model_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">all_donor_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">enable_clustering</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_frequentist_scm</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.pcr" title="Link to this definition">#</a></dt>
<dd></dd></dl>

</section>
<section id="internal-helper-functions">
<h2>Internal Helper Functions<a class="headerlink" href="#internal-helper-functions" title="Link to this heading">#</a></h2>
<p>These functions are primarily used internally by other functions in this module or by estimators.</p>
<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils._estimate_single_sc_model_for_tsest">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">_estimate_single_sc_model_for_tsest</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">scm_method_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">iteration_donor_features</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">treated_outcome_vector</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_pre_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_post_treatment_periods</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_bootstrap_samples</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">current_donor_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.13)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_iteration_donors_or_features</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils._estimate_single_sc_model_for_tsest" title="Link to this definition">#</a></dt>
<dd><p>Estimate a single SCM model for TSEST, calculate effects, and bootstrap CIs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>scm_method_name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a>) – Name of the SCM method (e.g., “SIMPLEX”, “MSCb”).</p></li>
<li><p><strong>iteration_donor_features</strong> (<em>np.ndarray</em>) – Feature matrix for donor units for the current iteration.</p></li>
<li><p><strong>treated_outcome_vector</strong> (<em>np.ndarray</em>) – Outcome vector for the treated unit.</p></li>
<li><p><strong>num_pre_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of pre-treatment periods.</p></li>
<li><p><strong>num_post_treatment_periods</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of post-treatment periods.</p></li>
<li><p><strong>num_bootstrap_samples</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of bootstrap samples.</p></li>
<li><p><strong>current_donor_names</strong> (<em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>]</em>) – List of donor names.</p></li>
<li><p><strong>num_iteration_donors_or_features</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Number of control units/features for the current iteration.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Dictionary containing results for the single SCM model.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils._solve_pda_fs">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">_solve_pda_fs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prepped_data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_donors_to_select</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils._solve_pda_fs" title="Link to this definition">#</a></dt>
<dd><p>Solve Panel Data Approach (PDA) using Forward Selection (‘fs’).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>prepped_data</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – Preprocessed data dictionary. Expected keys:
- ‘y’ (outcome_vector_treated): np.ndarray, outcome vector for the treated unit.
- ‘donor_matrix’ (donor_outcomes_matrix): np.ndarray, matrix of outcomes/features for donor units.
- ‘donor_names’ (all_donor_names): Union[pd.Index, List[str]], names of the original donor units.
- ‘pre_periods’ (num_pre_treatment_periods): int, number of pre-treatment time periods.
- ‘post_periods’ (num_post_treatment_periods): int, number of post-treatment time periods.</p></li>
<li><p><strong>max_donors_to_select</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><em>int</em></a>) – Maximum number of donor units to select by the forward selection algorithm.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Results dictionary for the ‘fs’ method.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils._solve_pda_lasso">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">_solve_pda_lasso</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prepped_data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils._solve_pda_lasso" title="Link to this definition">#</a></dt>
<dd><p>Solve Panel Data Approach (PDA) using LASSO.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>prepped_data</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – Preprocessed data dictionary. Expected keys:
- ‘y’ (outcome_vector_treated): np.ndarray, outcome vector for the treated unit.
- ‘donor_matrix’ (donor_outcomes_matrix): np.ndarray, matrix of outcomes/features for donor units.
- ‘donor_names’ (all_donor_names): Union[pd.Index, List[str]], names of the original donor units.
- ‘pre_periods’ (num_pre_treatment_periods): int, number of pre-treatment time periods.
- ‘post_periods’ (num_post_treatment_periods): int, number of post-treatment time periods.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Results dictionary for the ‘LASSO’ method.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils._solve_pda_l2">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">_solve_pda_l2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prepped_data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">l2_regularization_parameter</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils._solve_pda_l2" title="Link to this definition">#</a></dt>
<dd><p>Solve Panel Data Approach (PDA) using L2-relaxation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>prepped_data</strong> (<em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><em>str</em></a><em>, </em><em>Any</em><em>]</em>) – Preprocessed data dictionary. Expected keys:
- ‘y’ (outcome_vector_treated): np.ndarray, outcome vector for the treated unit.
- ‘donor_matrix’ (donor_outcomes_matrix): np.ndarray, matrix of outcomes/features for donor units.
- ‘donor_names’ (all_donor_names): Union[pd.Index, List[str]], names of the original donor units.
- ‘pre_periods’ (num_pre_treatment_periods): int, number of pre-treatment time periods.
- ‘post_periods’ (num_post_treatment_periods): int, number of post-treatment time periods.</p></li>
<li><p><strong>l2_regularization_parameter</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a><em>]</em>) – Tuning parameter (tau) for L2-relaxation. If None, it’s cross-validated.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Results dictionary for the ‘l2’ method.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dict[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)">str</a>, Any]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="mlsynth.utils.estutils.__SRC_opt">
<span class="sig-prename descclassname"><span class="pre">mlsynth.utils.estutils.</span></span><span class="sig-name descname"><span class="pre">__SRC_opt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">treated_outcome_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">donor_outcomes_post_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aligned_donor_outcomes_pre_treatment</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alignment_coefficients</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ndarray</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">noise_variance_estimate</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><span class="pre">float</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.13)"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">ndarray</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#mlsynth.utils.estutils.__SRC_opt" title="Link to this definition">#</a></dt>
<dd><p>Perform Synthetic Regressing Control (SRC) weight optimization and prediction.</p>
<p>This is a helper function for <cite>SRCest</cite>. It solves the SRC optimization
problem to find donor weights <cite>optimal_donor_weights</cite> and then constructs
pre-treatment predictions and post-treatment counterfactuals.</p>
<p>The optimization problem is:</p>
<p><code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">||treated_outcome_pre_treatment</span> <span class="pre">-</span> <span class="pre">aligned_donor_outcomes_pre_treatment</span> <span class="pre">&#64;</span> <span class="pre">donor_weights||_2**2</span> <span class="pre">+</span>
<span class="pre">2</span> <span class="pre">*</span> <span class="pre">noise_variance_estimate</span> <span class="pre">*</span> <span class="pre">sum(donor_weights)</span></code></p>
<p>subject to <code class="docutils literal notranslate"><span class="pre">donor_weights</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">sum(donor_weights)</span> <span class="pre">==</span> <span class="pre">1</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>treated_outcome_pre_treatment</strong> (<em>np.ndarray</em>) – Pre-treatment outcomes for the treated unit, shape (num_pre_treatment_periods,).</p></li>
<li><p><strong>donor_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Pre-treatment outcomes for donor units, shape (num_pre_treatment_periods, num_donors).</p></li>
<li><p><strong>donor_outcomes_post_treatment</strong> (<em>np.ndarray</em>) – Post-treatment outcomes for donor units, shape (num_post_treatment_periods, num_donors).</p></li>
<li><p><strong>aligned_donor_outcomes_pre_treatment</strong> (<em>np.ndarray</em>) – Pre-treatment donor outcomes aligned by <cite>alignment_coefficients</cite>,
shape (num_pre_treatment_periods, num_donors).</p></li>
<li><p><strong>alignment_coefficients</strong> (<em>np.ndarray</em>) – Estimated alignment coefficients, shape (num_donors,).</p></li>
<li><p><strong>noise_variance_estimate</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.13)"><em>float</em></a>) – Estimated noise variance from <cite>get_sigmasq</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><ul class="simple">
<li><dl class="simple">
<dt>predicted_treated_outcome_pre_treatment<span class="classifier">np.ndarray</span></dt><dd><p>In-sample predicted treated unit outcomes for the pre-treatment
period, shape (num_pre_treatment_periods,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>predicted_counterfactual_post_treatment<span class="classifier">np.ndarray</span></dt><dd><p>Predicted counterfactual outcomes for the treated unit in the
post-treatment period, shape (num_post_treatment_periods,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>optimal_donor_weights<span class="classifier">np.ndarray</span></dt><dd><p>Optimal donor weights, shape (num_donors,).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>alignment_coefficients<span class="classifier">np.ndarray</span></dt><dd><p>The input alignment coefficients, passed through, shape (num_donors,).</p>
</dd>
</dl>
</li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>Uses OSQP solver for the quadratic program.</p>
</dd></dl>

</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="datautils.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data Utilities (<cite>mlsynth.utils.datautils</cite>)</p>
      </div>
    </a>
    <a class="right-next"
       href="inferutils.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Inference Utilities (<cite>mlsynth.utils.inferutils</cite>)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-reference">Class Reference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.Opt"><code class="docutils literal notranslate"><span class="pre">Opt</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.Opt.SCopt"><code class="docutils literal notranslate"><span class="pre">Opt.SCopt()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#function-reference">Function Reference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi2"><code class="docutils literal notranslate"><span class="pre">pi2()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.compute_hac_variance"><code class="docutils literal notranslate"><span class="pre">compute_hac_variance()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.compute_t_stat_and_ci"><code class="docutils literal notranslate"><span class="pre">compute_t_stat_and_ci()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.l2_relax"><code class="docutils literal notranslate"><span class="pre">l2_relax()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.cross_validate_tau"><code class="docutils literal notranslate"><span class="pre">cross_validate_tau()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.ci_bootstrap"><code class="docutils literal notranslate"><span class="pre">ci_bootstrap()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.TSEST"><code class="docutils literal notranslate"><span class="pre">TSEST()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pda"><code class="docutils literal notranslate"><span class="pre">pda()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.bartlett"><code class="docutils literal notranslate"><span class="pre">bartlett()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.hac"><code class="docutils literal notranslate"><span class="pre">hac()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi"><code class="docutils literal notranslate"><span class="pre">pi()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi_surrogate"><code class="docutils literal notranslate"><span class="pre">pi_surrogate()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pi_surrogate_post"><code class="docutils literal notranslate"><span class="pre">pi_surrogate_post()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.get_theta"><code class="docutils literal notranslate"><span class="pre">get_theta()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.get_sigmasq"><code class="docutils literal notranslate"><span class="pre">get_sigmasq()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.SRCest"><code class="docutils literal notranslate"><span class="pre">SRCest()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.RPCASYNTH"><code class="docutils literal notranslate"><span class="pre">RPCASYNTH()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.SMOweights"><code class="docutils literal notranslate"><span class="pre">SMOweights()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.NSC_opt"><code class="docutils literal notranslate"><span class="pre">NSC_opt()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.NSCcv"><code class="docutils literal notranslate"><span class="pre">NSCcv()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.pcr"><code class="docutils literal notranslate"><span class="pre">pcr()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-helper-functions">Internal Helper Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._estimate_single_sc_model_for_tsest"><code class="docutils literal notranslate"><span class="pre">_estimate_single_sc_model_for_tsest()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_fs"><code class="docutils literal notranslate"><span class="pre">_solve_pda_fs()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_lasso"><code class="docutils literal notranslate"><span class="pre">_solve_pda_lasso()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils._solve_pda_l2"><code class="docutils literal notranslate"><span class="pre">_solve_pda_l2()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlsynth.utils.estutils.__SRC_opt"><code class="docutils literal notranslate"><span class="pre">__SRC_opt()</span></code></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jared Greathouse
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Jared Greathouse.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>